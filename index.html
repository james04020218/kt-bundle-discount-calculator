<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KT 결합 할인 계산기</title>
    <script src="https://cdn.tailwindcss.com"></script>
      
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
      
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc; 
            padding: 2rem;
        }

        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #334155; /* slate-700 */ }
        .input-field, .select-field { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #cbd5e1; /* slate-300 */ border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .input-field:focus, .select-field:focus { border-color: #0ea5e9; /* sky-500 */ outline: none; box-shadow: 0 0 0 0.2rem rgba(14, 165, 233, 0.25); }
        .input-field:disabled, .select-field:disabled { background-color: #e2e8f0; /* slate-200 */ cursor: not-allowed; }
        .btn-primary { background-color: #0ea5e9; /* sky-500 */ color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #0284c7; /* sky-600 */ }
        .btn-secondary { background-color: #64748b; /* slate-500 */ color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.3s ease; }
        .btn-secondary:hover { background-color: #475569; /* slate-600 */ }
        .section-title { font-size: 1.5rem; font-weight: 700; color: #0369a1; /* sky-700 */ margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #38bdf8 /* sky-400 */;}
        .result-card { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); margin-bottom: 1.5rem; }
        .result-label { color: #475569; /* slate-600 */ }
        .result-value { color: #1e293b; /* slate-800 */ font-weight: 600;}
        .total-value { color: #f59e0b; /* amber-500 */ font-size: 1.5rem; font-weight: 700;}
        .mobile-line-item { border: 1px solid #e2e8f0; /* slate-200 */ padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; }
        .radio-label { margin-right: 1rem; margin-bottom: 0.5rem; display: inline-flex; align-items: center; cursor: pointer;}
        .radio-input { margin-right: 0.5rem; accent-color: #0ea5e9; /* sky-500 */ }
        .info-box { background-color: #eff6ff; /* blue-50 */ border-left: 4px solid #3b82f6; /* blue-500 */ padding: 1rem; margin-top:0.5rem; margin-bottom:1rem; font-size: 0.875rem; color: #1e40af; /* blue-800 */;}
        .info-box ul { padding-left: 1.25rem; list-style-type: disc; }
        .info-box ul ul { padding-left: 1rem; list-style-type: circle;}
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-left: 10px; vertical-align: middle;}
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px;}
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;}
        input:checked + .slider { background-color: #2196F3; } /* KT Sky Blue for toggle */
        input:checked + .slider:before { transform: translateX(20px); }
        .discount-details { background-color: #f0f9ff; border: 1px solid #bae6fd; padding: 1rem; border-radius: 0.375rem; font-size:0.875rem; }
        .discount-details ul { padding-left: 1.25rem; }
        .discount-details ul ul { padding-left: 1rem; }
        .summary-item { margin-bottom: 0.25rem; }
        .message-script-area { width: 100%; min-height: 150px; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.875rem; white-space: pre-wrap; word-wrap: break-word; }
        .copy-button-container { text-align: right; margin-top: 0.5rem; }
        .copy-feedback { font-size: 0.75rem; color: green; margin-left: 0.5rem; }
    </style>
</head>
<body class="text-slate-800">
    <header class="bg-sky-700 text-white p-6 shadow-md">
        <div class="container mx-auto max-w-4xl">
            <h1 class="text-3xl font-bold text-center">KT 결합 할인 계산기</h1>
            <p class="text-center text-sky-200 mt-1">선택하신 서비스와 할인 유형에 따른 예상 요금을 계산해 보세요.</p>
        </div>
    </header>

    <main class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        <section id="inputSection" class="mb-8">
            <h2 class="section-title">1. 서비스 선택 (3년 약정 기준)</h2>
            <p class="mb-3 text-sm text-slate-600">아래 항목들을 선택하거나 입력해주세요. 모든 요금은 KT 표준 3년 약정 기준이며, 최종 계산 결과에서 부가세(VAT)가 포함된 금액과 별도 금액을 확인할 수 있습니다.</p>
             
            <div class="mb-2 text-sm">
                <p class="font-semibold text-red-600">⚠️ 민감정보</p>
                <p><a href="https://kt-sensitiveinfo.com" target="_blank" class="text-red-500 hover:text-red-700 underline font-medium break-all">https://kt-sensitiveinfo.com</a></p>
                <p class="text-slate-600">ㄴ> 위 링크를 고객에게 문자로 전송해주세요. (아래 스크립트 복사 기능 이용)</p>
            </div>
            <div class="mb-2 text-sm">
                <span class="font-semibold text-sky-700">참고 스프레드시트:</span>
                <a href="https://docs.google.com/spreadsheets/d/10d21RrhIPBiJr7RZIHnk0h1dB4GvTEcHCuXSyFYw1M4/edit?gid=0#gid=0" target="_blank" class="text-blue-600 hover:text-blue-700 underline font-medium">바로가기</a>
            </div>
            <div class="mb-4 text-sm">
                <span class="font-semibold text-sky-700">KT 인터넷 상품청약 본인인증 링크:</span>
                <a href="https://online.kt.com/smart/simple/simpleCustomerInfoPop.do?prdcId=0F0BA335-ACD6-459E-BDB3-95CE61EEFE35" target="_blank" class="text-blue-600 hover:text-blue-700 underline font-medium">바로가기 (PASS 또는 신용카드 인증)</a>
            </div>

            <div class="input-group">
                <label class="input-label">인터넷 유형 선택</label>
                <div class="flex items-center space-x-4">
                    <label class="radio-label">
                        <input type="radio" name="internetType" value="bundle" class="radio-input">
                        인터넷 + TV 번들
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="internetType" value="standalone" class="radio-input" checked>
                        인터넷 단독
                    </label>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="input-group">
                    <label for="internetPlan" class="input-label">인터넷 요금제</label>
                    <select id="internetPlan" class="select-field">
                    </select>
                </div>
                 
                <div class="input-group">
                    <label for="wifiRouterRental" class="input-label block mb-1">와이파이 공유기</label>
                    <select id="wifiRouterRental" class="select-field">
                        <option value="1000" data-name="KT공유기">KT공유기 (월 1,000원, VAT별도)</option>
                        <option value="0" data-name="GiGA WiFi home ax">GiGA WiFi home ax</option>
                        <option value="0" data-name="KT WiFi 7D">KT WiFi 7D</option>
                        <option value="0" data-name="KT공유기 X">KT공유기 X (미사용)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="tvPlan" class="input-label">TV 요금제 (1번째 TV, 기가지니A 포함가)</label>
                    <select id="tvPlan" class="select-field">
                        <option value="none" data-category="없음" data-stb-included-price="0">선택 안함</option>
                        <option value="KTTV베이직" data-price="14000" data-category="베이직" data-stb-included-price="14000">KTTV베이직 (236채널) + 기가지니A (월 14,000원, VAT별도)</option>
                        <option value="KTTV라이트" data-price="15000" data-category="라이트" data-stb-included-price="15000">KTTV라이트 (240채널) + 기가지니A (월 15,000원, VAT별도)</option>
                        <option value="KTTV에센스" data-price="18000" data-category="에센스" data-stb-included-price="18000">KTTV에센스 (266채널) + 기가지니A (월 18,000원, VAT별도)</option>
                        <option value="KTTV에센스 플러스" data-price="22000" data-category="에센스 플러스" data-stb-included-price="22000">KTTV에센스 플러스 (266+채널) (월 22,000원, VAT별도)</option>
                        <option value="KTTV넷플릭스 HD" data-price="28273" data-category="넷플릭스 HD" data-stb-included-price="28273">KTTV넷플릭스 HD (267채널) (월 28,273원, VAT별도)</option>
                        <option value="KTTV넷플릭스 UHD" data-price="31455" data-category="넷플릭스 UHD" data-stb-included-price="31455">KTTV넷플릭스 UHD (267채널) (월 31,455원, VAT별도)</option>
                        <option value="KTTV키즈랜드팩초이스" data-price="19000" data-category="키즈랜드" data-stb-included-price="19000">KTTV키즈랜드팩초이스 (월 19,000원, VAT별도)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="additionalTvPlan" class="input-label">추가 TV 선택 (2번째 TV)</label>
                    <select id="additionalTvPlan" class="select-field">
                        <option value="none" data-price="0" data-name="선택 안함">선택 안함</option>
                        <option value="KTTV 추가베이직" data-price="9700" data-name="베이직 (236채널) + 기가지니A">KTTV 추가베이직 (236채널) + 기가지니A (월 9,700원, VAT별도)</option>
                        <option value="KTTV 추가라이트" data-price="10200" data-name="라이트 (240채널) + 기가지니A">KTTV 추가라이트 (240채널) + 기가지니A (월 10,200원, VAT별도)</option>
                        <option value="KTTV 추가에센스" data-price="12200" data-name="에센스 (266채널) + 기가지니A">KTTV 추가에센스 (266채널) + 기가지니A (월 12,200원, VAT별도)</option>
                    </select>
                </div>
                 
                <div class="input-group">
                    <label for="phonePlan" class="input-label">집전화 요금제</label>
                    <select id="phonePlan" class="select-field">
                        <option value="none">선택 안함</option>
                        <option value="인터넷전화 우리끼리3000" data-price="5722">우리끼리3000 (월 5,722원, VAT별도)</option>
                        <option value="집전화 유선3000" data-price="7722">유선3000 (월 7,722원, VAT별도)</option>
                        <option value="집전화 유무선3000" data-price="7500">유무선3000 (월 7,500원, VAT별도)</option>
                    </select>
                </div>
            </div>
             
            <div class="input-group">
                <label class="input-label">KT 부가서비스 (선택)</label>
                <div id="addonServicesContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <label class="flex items-center"><input type="checkbox" name="addonService" value="기가지니3A" data-price="1000" class="radio-input mr-2">기가지니3A (AI 셋톱박스) (월 1,000원, VAT별도)</label>
                    <label class="flex items-center"><input type="checkbox" name="addonService" value="AI 지니 TV 올인원 사운드바" data-price="5000" class="radio-input mr-2">AI 지니 TV 올인원 사운드바 (월 5,000원, VAT별도)</label>
                    <label class="flex items-center"><input type="checkbox" name="addonService" value="버디증폭기" data-price="1500" class="radio-input mr-2">버디증폭기 (월 1,500원, VAT별도)</label>
                    <label class="flex items-center"><input type="checkbox" name="addonService" value="기가지니 4A" data-price="3000" class="radio-input mr-2">기가지니 4A (월 3,000원, VAT별도)</label>
                </div>
            </div>
        </section>

        <section id="discountTypeSection" class="mb-8">
            <h2 class="section-title">2. 결합 할인 유형 선택</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <p class="mb-4 text-sm text-slate-600">가장 유리한 할인 유형을 선택하거나, 각 유형별 예상 요금을 비교해보세요.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                    <label class="radio-label"><input type="radio" name="discountType" value="none" class="radio-input"> 결합 할인 없음</label>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="totalAmountBundle" class="radio-input" checked> 총액 결합할인</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="totalAmountDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="fixedRateBundle" class="radio-input"> 정액 결합할인</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="fixedRateDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="premiumFamilyBundle" class="radio-input"> 프리미엄 가족결합</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="premiumFamilyDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="premiumSingleBundle" class="radio-input"> 프리미엄 싱글결합</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="premiumSingleDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="mvnoBundle" class="radio-input"> 알뜰폰 결합</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="mvnoDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="familyBundle" class="radio-input"> 패밀리 결합 (인터넷 추가회선)</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="familyBundleDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="separateFamilyBundle" class="radio-input"> 따로 살아도 가족결합</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="separateFamilyDetailsToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                </div>

                <div id="totalAmountDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="fixedRateDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="premiumFamilyDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="premiumSingleDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="familyBundleDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="separateFamilyDetailsContainer" class="mt-4 hidden discount-details"></div>
                <div id="mvnoDetailsContainer" class="mt-4 hidden discount-details"></div>

                <div class="input-group mt-6">
                    <label class="input-label">모바일 회선 정보 (최대 10회선)</label>
                    <div class="flex items-center mb-2">
                        <label for="mobileLinesCount" class="mr-2 text-sm text-slate-700">결합할 모바일 회선 수:</label>
                        <input type="number" id="mobileLinesCount" min="0" max="10" value="0" class="input-field w-20 text-center">
                    </div>
                    <div id="mobileLinesContainer" class="space-y-3"></div>
                </div>
                <div class="input-group mt-6">
                    <label for="dongpanSalesCheckKt" class="input-label flex items-center cursor-pointer">
                        <input type="checkbox" id="dongpanSalesCheckKt" class="radio-input h-5 w-5 mr-2">
                        KT 동판유심 판매 시 추가 사은품 적용 및 안내 보기
                    </label>
                    <div id="dongpanPolicyDetailsContainerKt" class="mt-3 hidden info-box">
                        <h4 class="font-semibold text-sm mb-2">KT 인터넷 유심 개통 절차 안내 (상담원 참고용)</h4>
                        <p class="text-xs mb-1"><strong>신청 및 인증:</strong></p>
                        <ul class="list-disc list-inside text-xs space-y-0.5 mb-2">
                            <li>KT 인터넷 유심 개통 신청서 링크: <a href="http://online.kt.com/index.jsp?prdcID=6C463388-3BDF-4E68-BE73-975E05BDA182" target="_blank" class="text-blue-700 font-bold hover:text-blue-800 underline text-lg">바로가기</a> (PASS 또는 신용카드 인증 필요)</li>
                            <li>KT 동판 결합 본인인증 링크 (결합만 체크): <a href="https://online.kt.com/smart/simple/simpleCustomerInfoPop.do?prdcId=65278B4C-20F1-47FA-9EEF-56E9B574D346" target="_blank" class="text-blue-600 hover:underline font-semibold">바로가기</a></li>
                        </ul>
                        <p class="text-xs mb-1"><strong>결합 가능 회선:</strong> 인터넷 + 유심 동판 + 가족 유심 2회선 (총 3회선까지 가능)</p>
                        <p class="text-xs mb-1"><strong>접수 과정:</strong> 백메가 접수웹(speedonline.kr) KT(일반) > 모바일 탭으로 접수</p>
                        <p class="text-xs mb-1"><strong>접수 시 필수 기재 사항 (기타메모 양식):</strong></p>
                        <ul class="list-disc list-inside text-xs space-y-0.5 mb-2">
                            <li>인터넷 개통 완료 시: "[개통 완료 / 유심 발송 요청]"</li>
                            <li>이미 개통된 고객 30일 이내 동판 시: "[개통완료 일자, 개통번호 기재 / 유심 발송 요청]"</li>
                            <li>고객 유심 수령 후 개통 요청 시: "[고객 유심 수령 완료 / 개통 진행 요청]"</li>
                        </ul>
                        <p class="text-xs mb-1"><strong>개통 진행 및 유의사항:</strong></p>
                        <ul class="list-disc list-inside text-xs space-y-0.5 mb-2">
                            <li>고객에게 위약금 확인 및 동의 문자 발송 후 처리. 미동의 시 10분 후 강제 동의 처리 가능.</li>
                            <li>USIM 교체 및 전원 ON 성공 후 선택약정 및 유무선 결합 필수 (완료 시 개통 완료 처리).</li>
                            <li>유심 개통 최대 4시간 소요 가능. 사전 동의 문자 처리 시 빠른 개통.</li>
                            <li>KT USIM 개통 전까지 기존 USIM 사용, 신호 끊기면 교체. 기기 수회 재시동 필요.</li>
                        </ul>
                        <p class="text-xs mb-1"><strong>비용 및 수수료 주의사항:</strong></p>
                        <ul class="list-disc list-inside text-xs space-y-0.5">
                            <li>유심 당일 발송 마감 15시.</li>
                            <li>유심 비용 7,700원 / 번호이동 수수료 800원 첫 달 청구.</li>
                            <li>인터넷/유심 중 하나라도 설치/개통 불가 시 수수료 지급 불가.</li>
                            <li>인터넷 개통월 기준 익월 말까지 유심 개통 시 수수료 인정.</li>
                            <li>선택약정 미적용 시 수수료 지급 불가.</li>
                            <li>인터넷/유심 명의자 상이해도 유심 수수료 지급 가능.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
          
        <section id="installationSection" class="mb-8">
            <h2 class="section-title">3. 설치 옵션</h2>
            <div class="input-group bg-white p-6 rounded-lg shadow">
                <label class="input-label">설치 희망 시점 (설치비 변동)</label>
                <div class="space-y-2">
                    <label class="radio-label"><input type="radio" name="installationTime" value="weekday" class="radio-input" checked> 평일 주간</label>
                    <label class="radio-label"><input type="radio" name="installationTime" value="weekend" class="radio-input"> 주말/야간 (할증 적용)</label>
                </div>
                <div class="mt-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="installationFeeSelfPay" class="radio-input mr-2">
                        <span class="text-sm font-medium">설치비 자체지급 (사은품에서 차감되지 않음)</span>
                    </label>
                </div>
            </div>
        </section>

        <section id="affiliateCardSection" class="mb-8">
            <h2 class="section-title">4. 제휴카드 추가 할인 (선택 사항)</h2>
            <div class="input-group bg-white p-6 rounded-lg shadow">
                <label for="affiliateCard" class="input-label">제휴카드 선택</label>
                <select id="affiliateCard" class="select-field">
                    <option value="none">할인 미적용</option>
                    <option value="woori">우리카드</option>
                    <option value="lotte">롯데카드</option>
                    <option value="nh">농협카드</option>
                    <option value="shinhan">신한카드</option>
                    <option value="samsung">삼성카드</option>
                    <option value="hyundai">현대카드</option>
                    <option value="bc">BC바로카드</option>
                    <option value="hana">하나카드</option>
                </select>
                 
                <div id="cardTierContainer" class="mt-4 hidden">
                    <label class="input-label">전월 실적 구간 선택</label>
                    <div id="cardTiers" class="space-y-2">
                    </div>
                </div>
            </div>
        </section>
        <div class="text-center mb-8 flex justify-center items-center">
            <button id="calculateButton" class="btn-primary text-lg">예상 요금 계산하기</button>
            <button id="resetButton" class="btn-secondary text-lg ml-4">초기화</button>
        </div>

        <section id="resultSection" class="hidden">
            <h2 class="section-title">📊 계산 결과</h2>
             
            <div class="result-card">
                <h3 class="text-xl font-semibold text-sky-600 mb-4">✅ 최종 요금 및 혜택 요약 (VAT 포함)</h3>
                <div class="grid grid-cols-2 gap-6 text-center">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">🖥️ 인터넷/TV 월 최종 요금</p>
                        <p id="summaryPreDiscountCost" class="text-sm text-slate-500" style="display: none;"></p>
                        <p id="summaryFinalCost" class="text-3xl font-bold text-red-600 my-2">0 원</p>
                        <p id="summaryCardApplied" class="text-xs text-slate-500 h-4"></p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">🎁 최대 혜택 금액</p>
                        <p id="summaryGiftTotal" class="text-3xl font-bold text-green-700 my-2">0 원</p>
                        <p id="summaryGiftBreakdown" class="text-xs text-slate-500"></p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">📉 인터넷 요금 할인</p>
                        <p id="summaryInternetDiscount" class="text-xl font-bold text-sky-600 my-2">0 원</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-slate-600">📱 휴대폰 요금 할인</p>
                        <p id="summaryMobileDiscount" class="text-xl font-bold text-green-700 my-2">0 원</p>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <button id="toggleDetailsButton" class="text-sm text-slate-500 hover:text-sky-600 bg-slate-100 px-4 py-2 rounded-full">
                        상세 요금 내역 펼쳐보기 ▼
                    </button>
                </div>
            </div>

            <div id="recommendationBox" class="result-card bg-sky-50 border-l-4 border-sky-400 my-4 hidden">
                <h3 id="recommendationTitle" class="text-lg font-semibold text-sky-800"></h3>
                <p id="recommendationBody" class="text-sm text-slate-700 mt-2"></p>
                <div id="recommendationAction" class="text-right mt-3"></div>
            </div>

            <div id="expandedDetailsContainer" class="hidden">
                <div class="result-card">
                    <h3 class="text-2xl font-bold text-blue-700 mb-4">📋 상세 요금 내역 (VAT 별도)</h3>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                        <p><strong>선택 인터넷:</strong> <span id="selectedInternet"></span></p>
                        <p><strong>모바일 회선 수:</strong> <span id="selectedMobileCount"></span></p>
                        <p><strong>선택 TV (1번째):</strong> <span id="selectedTv"></span></p>
                        <p><strong>적용 할인 유형:</strong> <span id="selectedDiscountType"></span></p>
                        <p><strong>선택 추가 TV (2번째):</strong> <span id="selectedAdditionalTv"></span></p>
                        <p><strong>선택 집전화:</strong> <span id="selectedPhone"></span></p>
                        <p><strong>선택 와이파이:</strong> <span id="selectedWifi"></span></p>
                        <div></div> <div class="col-span-2" id="selectedWifiDetails"></div> 
                    </div>
                </div>

                <div class="result-card">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">🖥️ 인터넷/TV 요금 계산 과정 (VAT 별도)</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>월 기본료 합계 (인터넷/TV/전화 등)</span><span id="detailInternetBase">0 원</span></div>
                        <div class="flex justify-between"><span>월 와이파이 공유기 임대료</span><span id="detailWifiFee">0 원</span></div>
                        <div class="flex justify-between text-green-600"><span>월 총 인터넷 결합 할인액 (예상)</span><span id="detailInternetDiscountTotal">0 원</span></div>
                        <hr class="my-2">
                        <div class="flex justify-between font-bold text-base"><span>할인 적용 후 월 납부액 (VAT 별도)</span><span id="detailFinalCostPreVat" class="text-slate-700">0 원</span></div>
                        <div class="flex justify-between font-bold text-base"><span>부가세 (VAT 10%)</span><span id="detailVatAmount" class="text-slate-700">0 원</span></div>
                        <hr class="my-2">
                        <div class="flex justify-between font-bold text-xl"><span>최종 예상 월 납부액 (VAT 포함)</span><span id="detailFinalCost" class="text-red-600">0 원</span></div>
                          
                        <div id="detailCardDiscountContainer" class="hidden flex justify-between font-bold text-blue-600">
                            <span>제휴카드 추가 할인 (<span id="selectedCardName"></span>)</span>
                            <span id="detailCardDiscount">- 0 원</span>
                        </div>
                        <hr id="finalCardCostSeparator" class="my-2 hidden">
                        <div id="detailFinalCardCostContainer" class="hidden flex justify-between font-bold text-xl">
                            <span>✨ 카드 적용 최종 납부액 (VAT 포함)</span>
                            <span id="detailFinalCardCost" class="text-fuchsia-600">0 원</span>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">📱 모바일 요금 할인 상세 (VAT 포함)</h3>
                    <div id="mobileDiscountDetailContainer" class="p-3 bg-blue-50 rounded-md text-sm">
                        <p>결합 유형에 따른 모바일 할인 내역이 여기에 표시됩니다.</p>
                    </div>
                </div>

                <div class="result-card">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">🎁 사은품 혜택 상세</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>기본 사은품 (현금)</span><span id="giftCash">0 원</span></div>
                        <div class="flex justify-between"><span>기본 사은품 (상품권)</span><span id="giftVoucher">0 원</span></div>
                        <div class="flex justify-between"><span>일반전화 추가 상품권</span><span id="giftPhoneVoucher">0 원</span></div>
                        <div class="flex justify-between"><span>추가 TV 사은품 (현금)</span><span id="giftAdditionalTv">0 원</span></div>
                        <div id="dongpanCashContainerKt" class="flex justify-between hidden"><span>동판 추가 현금 사은품 (KT)</span><span id="giftDongpanAdditionalCashKt">0 원</span></div>
                        <hr class="my-1 border-dashed">
                        <div class="flex justify-between font-bold text-base mt-2">
                            <span>총 사은품 합계</span>
                            <span id="giftTotal" class="text-green-700">0 원</span>
                        </div>
                    </div>
                </div>
            </div>
             
            <section id="installationFeeSection" class="hidden">
                <div class="result-card">
                    <h3 class="text-lg font-semibold text-blue-700 mb-3">⚙️ 설치비 (첫 달 1회 청구, VAT 포함)</h3>
                    <div class="text-center">
                        <p id="installationFeeResult" class="text-2xl font-bold text-slate-800 my-2">0 원</p>
                        <p id="installationFeeDescription" class="text-sm text-slate-500"></p>
                    </div>
                </div>
            </section>
        </section>

        <section id="messageScriptSection" class="hidden mt-12">
            <h2 class="section-title">📄 고객 안내 문자 스크립트 (상담원 참고용)</h2>
            <div class="result-card">
                <h3 class="text-xl font-semibold text-sky-600 mb-3">1. 웨이팅 인터넷 통합접수센터 전산 메모</h3>
                <textarea id="memoScript" class="message-script-area" readonly></textarea>
                <div class="copy-button-container">
                    <button onclick="copyToClipboard('memoScript', 'copyFeedbackMemo')" class="btn-secondary text-xs">복사하기</button>
                    <span id="copyFeedbackMemo" class="copy-feedback"></span>
                </div>
            </div>
            <div class="result-card">
                <h3 class="text-xl font-semibold text-sky-600 mb-3">2. 상품 안내 문자</h3>
                <div class="mb-3 text-right">
                    <button id="generateComparisonButton" class="btn-primary text-xs py-1 px-3">⚡ 100M vs 500M 비교 스크립트 생성</button>
                    <button id="generateDiscountTypeComparisonButton" class="btn-primary text-xs py-1 px-3 ml-2">⚡ 총액 vs 정액 비교 스크립트 생성</button>
                </div>
                <textarea id="infoScript" class="message-script-area" readonly></textarea>
                <div class="copy-button-container">
                    <button onclick="copyToClipboard('infoScript', 'copyFeedbackInfo')" class="btn-secondary text-xs">복사하기</button>
                    <span id="copyFeedbackInfo" class="copy-feedback"></span>
                </div>
            </div>
            <div class="result-card">
                <h3 class="text-xl font-semibold text-sky-600 mb-3">3. 가입 완료 문자</h3>
                <textarea id="completeScript" class="message-script-area" readonly></textarea>
                <div class="copy-button-container">
                    <button onclick="copyToClipboard('completeScript', 'copyFeedbackComplete')" class="btn-secondary text-xs">복사하기</button>
                    <span id="copyFeedbackComplete" class="copy-feedback"></span>
                </div>
            </div>
            <div class="result-card">
                <h3 class="text-xl font-semibold text-sky-600 mb-3">4. [웨이팅 인터넷 통합접수센터] 유심 접수 완료 안내</h3>
                <textarea id="usimCompleteScript" class="message-script-area" readonly></textarea>
                <div class="copy-button-container">
                    <button onclick="copyToClipboard('usimCompleteScript', 'copyFeedbackUsimComplete')" class="btn-secondary text-xs">복사하기</button>
                    <span id="copyFeedbackUsimComplete" class="copy-feedback"></span>
                </div>
            </div>
            <div class="result-card">
                <h3 class="text-xl font-semibold text-sky-600 mb-3">5. 민감정보 전송용 링크 (고객 발송용)</h3>
                <textarea id="sensitiveInfoLinkScript" class="message-script-area" readonly></textarea>
                <div class="copy-button-container">
                    <button onclick="copyToClipboard('sensitiveInfoLinkScript', 'copyFeedbackSensitiveInfo')" class="btn-secondary text-xs">복사하기</button>
                    <span id="copyFeedbackSensitiveInfo" class="copy-feedback"></span>
                </div>
            </div>
             
             
            <div class="result-card">
                <h3 class="text-xl font-semibold text-sky-600 mb-3">6. (고객 설득용) 1년 vs 3년 약정 최종 비용 비교</h3>
                <textarea id="tcoComparisonScript" class="message-script-area" readonly></textarea>
                <div class="copy-button-container">
                    <button onclick="copyToClipboard('tcoComparisonScript', 'copyFeedbackTco')" class="btn-secondary text-xs">복사하기</button>
                    <span id="copyFeedbackTco" class="copy-feedback"></span>
                </div>
            </div>
            <div class="result-card">
                <h3 class="text-xl font-semibold text-sky-600 mb-3">7. (전문가용) KT 위약금 산정 방식 상세 분석</h3>
                <textarea id="penaltyAnalysisScript" class="message-script-area" readonly></textarea>
                <div class="copy-button-container">
                    <button onclick="copyToClipboard('penaltyAnalysisScript', 'copyFeedbackPenalty')" class="btn-secondary text-xs">복사하기</button>
                    <span id="copyFeedbackPenalty" class="copy-feedback"></span>
                </div>
            </div>
            <div class="result-card">
                <h3 class="text-xl font-semibold text-sky-600 mb-3">8. (상세 안내) 위약금 면제 조건 총정리</h3>
                <textarea id="penaltyWaiverScript" class="message-script-area" readonly></textarea>
                <div class="copy-button-container">
                    <button onclick="copyToClipboard('penaltyWaiverScript', 'copyFeedbackWaiver')" class="btn-secondary text-xs">복사하기</button>
                    <span id="copyFeedbackWaiver" class="copy-feedback"></span>
                </div>
            </div>
        </section>
    </main>

    <footer class="text-center p-6 mt-12 bg-sky-800 text-sky-200 text-sm">
        <p>본 계산기는 웨이팅 인터넷 통합접수센터에서 제공합니다.</p>
        <p>&copy; 2024 KT 결합 할인 계산기. 모든 정보는 참고용입니다.</p>
    </footer>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        // script.js (Modified version with VAT handling and updated features)
          
        // Helper function for VAT conversion (Request 4)
        function toPreVat(price) {
            return Math.round(price / 1.1);
        }
          
        // (Request 4: All prices converted to pre-VAT)
        const internetPlans_KT = {
            "KT인터넷(단독) 100mb": { basePrice: 20000, speed: 100, type: "100M" },
            "KT인터넷(단독) 500mb": { basePrice: 30000, speed: 500, type: "500M" },
            "KT인터넷(단독) 500mb+OTT": { basePrice: 30000, speed: 500, type: "500M", isOttPlan: true },
            "KT인터넷(단독) 1GB": { basePrice: 35000, speed: 1000, type: "1G" },
            "KT인터넷(단독) 1GB+OTT": { basePrice: 35000, speed: 1000, type: "1G", isOttPlan: true },
            "KT인터넷번들100mb": { basePrice: 20000, speed: 100, type: "100M" },
            "KT인터넷번들500mb": { basePrice: 25000, speed: 500, type: "500M" },
            "KT인터넷번들500mb+OTT": { basePrice: 25000, speed: 500, type: "500M", isOttPlan: true },
            "KT인터넷번들1GB": { basePrice: 30000, speed: 1000, type: "1G" },
            "KT인터넷번들1GB+OTT": { basePrice: 30000, speed: 1000, type: "1G", isOttPlan: true }
        };
          
        const tvPlans_KT = {
            "KTTV베이직": { basePrice: 14000, category: "베이직", stbIncluded: "기가지니A" }, // 15400 -> 14000
            "KTTV라이트": { basePrice: 15000, category: "라이트", stbIncluded: "기가지니A" }, // 16500 -> 15000
            "KTTV에센스": { basePrice: 18000, category: "에센스", stbIncluded: "기가지니A" }, // 19800 -> 18000
            "KTTV에센스 플러스": { basePrice: 22000, category: "에센스 플러스", stbIncluded: "기가지니A" }, // 24200 -> 22000
            "KTTV넷플릭스 HD": { basePrice: toPreVat(31100), category: "넷플릭스 HD", stbIncluded: "기가지니A" },
            "KTTV넷플릭스 UHD": { basePrice: toPreVat(34600), category: "넷플릭스 UHD", stbIncluded: "기가지니A" },
            "KTTV키즈랜드팩초이스": { basePrice: 19000, category: "키즈랜드", stbIncluded: "기가지니A" } // 20900 -> 19000
        };
          
        const additionalTvPlans_KT = {
            "none": { basePrice: 0, name: "선택 안함" },
            "KTTV 추가베이직": { basePrice: 9700, name: "베이직 (236채널) + 기가지니A" }, // 10670 -> 9700
            "KTTV 추가라이트": { basePrice: 10200, name: "라이트 (240채널) + 기가지니A" }, // 11220 -> 10200
            "KTTV 추가에센스": { basePrice: 12200, name: "에센스 (266채널) + 기가지니A" } // 13420 -> 12200
        };
          
        const phonePlans_KT = {
            "인터넷전화 우리끼리3000": { basePrice: toPreVat(6294) },
            "집전화 유선3000": { basePrice: toPreVat(8494) },
            "집전화 유무선3000": { basePrice: 7500 } // 8250 -> 7500
        };
          
        const wifiOptions_KT = {
            "KT공유기": { fee: 1000, name: "KT공유기", url: null, promotion: null }, // 1100 -> 1000
            "GiGA WiFi home ax": { fee: 0, name: "GiGA WiFi home ax", url: "https://product.kt.com/wDic/productDetail.do?ItemCode=1401", promotion: "'베이직(500Mbps)' 요금제 신규 가입 시 무료 제공" },
            "KT WiFi 7D": { fee: 0, name: "KT WiFi 7D", url: "https://product.kt.com/wDic/productDetail.do?ItemCode=1633", promotion: "'에센스(1Gbps)' 이상 요금제 신규 가입 시 무료 제공 (25년 8/31까지, 선착순 5만명)" },
            "KT공유기 X": { fee: 0, name: "KT공유기 X (미사용)", url: null, promotion: null }
        };
          
          
        const ktAddonServices = {
            "기가지니3A": { price: 1000, name: "기가지니3A (AI 셋톱박스)"}, // 1100 -> 1000
            "AI 지니 TV 올인원 사운드바": { price: 5000, name: "AI 지니 TV 올인원 사운드바"}, // 5500 -> 5000
            "버디증폭기": { price: 1500, name: "버디증폭기"}, // 1650 -> 1500
            "기가지니 4A": { price: 3000, name: "기가지니 4A"} // 3300 -> 3000
        };
          
        // (Request 5: Replaced affiliate card data)
        const affiliateCardDiscounts = {
            "woori": {
                name: "우리카드",
                phone: "1588-9955", // Placeholder
                tiers: [
                    { usage: 400000, discount: 25000, label: "40만원 이상 사용" },
                    { usage: 800000, discount: 26000, label: "80만원 이상 사용" },
                    { usage: 1200000, discount: 27000, label: "120만원 이상 사용" }
                ]
            },
            "lotte": {
                name: "롯데카드",
                phone: "1588-8100",
                tiers: [
                    { usage: 400000, discount: 20000, label: "40만원 이상 사용" },
                    { usage: 800000, discount: 22000, label: "80만원 이상 사용" }
                ]
            },
            "nh": {
                name: "농협카드",
                phone: "1644-4000", // Placeholder
                tiers: [
                    { usage: 400000, discount: 14000, label: "40만원 이상 사용" },
                    { usage: 800000, discount: 19000, label: "80만원 이상 사용" }
                ]
            },
            "shinhan": {
                name: "신한카드",
                phone: "1544-7000",
                tiers: [
                    { usage: 300000, discount: 15000, label: "30만원 이상 사용" }
                ]
            },
            "samsung": {
                name: "삼성카드",
                phone: "1588-8700",
                tiers: [
                    { usage: 300000, discount: 18000, label: "30만원 이상 사용" },
                    { usage: 700000, discount: 19000, label: "70만원 이상 사용" }
                ]
            },
            "hyundai": {
                name: "현대카드",
                phone: "1577-6000",
                tiers: [
                    { usage: 500000, discount: 30000, label: "50만원 이상 사용" },
                    { usage: 1000000, discount: 35000, label: "100만원 이상 사용" }
                ]
            },
            "bc": {
                name: "BC바로카드",
                phone: "1588-4000",
                tiers: [
                    { usage: 300000, discount: 15000, label: "30만원 이상 사용" },
                    { usage: 700000, discount: 18000, label: "70만원 이상 사용" }
                ]
            },
            "hana": {
                name: "하나카드",
                phone: "1800-1111", // Placeholder
                tiers: [
                    { usage: 300000, discount: 10000, label: "30만원 이상 사용" },
                    { usage: 800000, discount: 15000, label: "80만원 이상 사용" }
                ]
            }
        };
          
        // Mobile plans remain VAT included as they are typically reported that way
        const mobilePlans_KT = [
            { "category": "90K", "name": "디즈니+ 초이스 스페셜", "network": "5G", "price": 110000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1470" },
            { "category": "90K", "name": "(유튜브 프리미엄) 초이스 스페셜", "network": "5G", "price": 110000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1499" },
            { "category": "90K", "name": "넷플릭스 초이스 스페셜", "network": "5G", "price": 110000, "url": "https://product.kt.com/wDic/simple/mNetflixMain.do" },
            { "category": "90K", "name": "티빙/지니/밀리 초이스 스페셜", "network": "5G", "price": 110000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1601" },
            { "category": "90K", "name": "넷플릭스 초이스 베이직", "network": "5G", "price": 90000, "url": "https://product.kt.com/wDic/simple/mNetflixMain.do" },
            { "category": "90K", "name": "티빙/지니/밀리 초이스 베이직", "network": "5G", "price": 90000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1601" },
            { "category": "90K", "name": "디즈니+ 초이스 베이직", "network": "5G", "price": 90000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1470" },
            { "category": "90K", "name": "(유튜브 프리미엄) 초이스 베이직", "network": "5G", "price": 90000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1499" },
            { "category": "61K", "name": "데이터ON 프리미엄", "network": "LTE", "price": 89000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1248" },
            { "category": "61K", "name": "베이직", "network": "5G", "price": 80000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1283" },
            { "category": "61K", "name": "5G 심플 110GB", "network": "5G", "price": 69000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1406&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "61K", "name": "데이터ON 비디오 플러스", "network": "LTE", "price": 69000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1248" },
            { "category": "61K", "name": "5G 심플 90GB", "network": "5G", "price": 67000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1406&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "61K", "name": "5G 심플 70GB", "network": "5G", "price": 65000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1406&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "61K", "name": "5G 심플 50GB", "network": "5G", "price": 63000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1406&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "61K", "name": "5G 심플 30GB", "network": "5G", "price": 61000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1406&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 슬림 21GB", "network": "5G", "price": 58000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 슬림 21GB (이월)", "network": "5G", "price": 58000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 슬림 14GB", "network": "5G", "price": 55000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 슬림 14GB (이월)", "network": "5G", "price": 55000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 슬림 10GB", "network": "5G", "price": 50000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 슬림 10GB (이월)", "network": "5G", "price": 50000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 시니어 베이직", "network": "5G", "price": 49000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1558&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 슬림 7GB", "network": "5G", "price": 45000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 슬림 7GB (이월)", "network": "5G", "price": 45000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 시니어 A형", "network": "5G", "price": 44000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1558&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 시니어 B형", "network": "5G", "price": 42000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1558&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 시니어 C형", "network": "5G", "price": 41000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1558&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 슬림 5GB", "network": "5G", "price": 37000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" },
            { "category": "37K", "name": "5G 슬림 4GB (이월)", "network": "5G", "price": 37000, "url": "https://product.kt.com/wDic/productDetail.do?ItemCode=1284&CateCode=6002&filter_code=81&option_code=109&pageSize=10" }
        ].sort((a, b) => b.price - a.price);
          
        // (Request 4: All discount amounts converted to pre-VAT)
        const newKtDiscountRules = {
            "총액결합할인": {
                "100M": {
                    "단독": {"모바일_22000미만": 1500, "모바일_64900미만": 3000, "모바일_64900이상": 5000}, // 1650->1500, 3300->3000, 5500->5000
                    "TV":    {"모바일_22000미만": 1500, "모바일_64900미만": 3000, "모바일_64900이상": 5000}
                },
                "500M": {
                    "단독": {"모바일_22000미만": 7000, "모바일_22000이상": 10000}, // 7700->7000, 11000->10000
                    "TV":    {"모바일_22000미만": 2000, "모바일_22000이상": 5000} // 2200->2000, 5500->5000
                },
                "1G": {
                    "단독": {"모바일_22000미만": 7000, "모바일_22000이상": 10000},
                    "TV":    {"모바일_결합시": 5000}
                }
            },
            "프리미엄가족결합": {
                "500M_TV": 5000, "1G_TV": 5000,
                "500M_단독": 5000, "1G_단독": 10000
            },
            "프리미엄싱글결합": {
                "500M_단독": 5000, "1G_단독": 5000
            },
            "패밀리결합": {
                "100M_TV": 5000, "100M_단독": 5000,
                "500M_TV": 5000, "500M_단독": 10000,
                "1G_TV": 5000,    "1G_단독": 10000
            },
            "알뜰폰결합": {
                "100M_TV": 3000, "100M_단독": 3000, // 3300->3000
                "500M_TV": 5000, "500M_단독": 10000,
                "1G_TV": 5000,    "1G_단독": 10000
            }
        };
          
        // Dongpan gifts remain as cash amounts (no VAT applicable)
        const dongpanGiftRules_New = {
            "37K 요금제": {
                "100Mb 단독 일반": { "인터넷 명의자 사은품": { "유심": 150000 }, "가족 사은품": "제공 불가" },
                "100Mb 단독 패밀리": { "인터넷 명의자 사은품": { "유심": 150000 }, "가족 사은품": "제공 불가" },
                "500Mb 단독 일반": { "인터넷 명의자 사은품": { "유심": 160000 }, "가족 사은품": "제공 불가" },
                "500Mb 단독 패밀리": { "인터넷 명의자 사은품": { "유심": 160000 }, "가족 사은품": "제공 불가" },
                "1Gb 단독 일반": { "인터넷 명의자 사은품": { "유심": 170000 }, "가족 사은품": "제공 불가" },
                "1Gb 단독 패밀리": { "인터넷 명의자 사은품": { "유심": 170000 }, "가족 사은품": "제공 불가" },
                "100Mb+TV 일반": { "인터넷 명의자 사은품": { "유심": 200000 }, "가족 사은품": 60000 },
                "100Mb+TV 패밀리": { "인터넷 명의자 사은품": { "유심": 200000 }, "가족 사은품": 60000 },
                "500Mb+TV 일반": { "인터넷 명의자 사은품": { "유심": 220000 }, "가족 사은품": 60000 },
                "500Mb+TV 패밀리": { "인터넷 명의자 사은품": { "유심": 220000 }, "가족 사은품": 60000 },
                "1Gb+TV 일반": { "인터넷 명의자 사은품": { "유심": 240000 }, "가족 사은품": 60000 },
                "1Gb+TV 패밀리": { "인터넷 명의자 사은품": { "유심": 240000 }, "가족 사은품": 60000 }
            },
            "61K 요금제": {
                "100Mb 단독 일반": { "인터넷 명의자 사은품": { "유심": 270000 }, "가족 사은품": "제공 불가" },
                "100Mb 단독 패밀리": { "인터넷 명의자 사은품": { "유심": 270000 }, "가족 사은품": "제공 불가" },
                "500Mb 단독 일반": { "인터넷 명의자 사은품": { "유심": 280000 }, "가족 사은품": "제공 불가" },
                "500Mb 단독 패밀리": { "인터넷 명의자 사은품": { "유심": 280000 }, "가족 사은품": "제공 불가" },
                "1Gb 단독 일반": { "인터넷 명의자 사은품": { "유심": 290000 }, "가족 사은품": "제공 불가" },
                "1Gb 단독 패밀리": { "인터넷 명의자 사은품": { "유심": 290000 }, "가족 사은품": "제공 불가" },
                "100Mb+TV 일반": { "인터넷 명의자 사은품": { "유심": 320000 }, "가족 사은품": 120000 },
                "100Mb+TV 패밀리": { "인터넷 명의자 사은품": { "유심": 320000 }, "가족 사은품": 120000 },
                "500Mb+TV 일반": { "인터넷 명의자 사은품": { "유심": 340000 }, "가족 사은품": 130000 },
                "500Mb+TV 패밀리": { "인터넷 명의자 사은품": { "유심": 340000 }, "가족 사은품": 120000 },
                "1Gb+TV 일반": { "인터넷 명의자 사은품": { "유심": 360000 }, "가족 사은품": 130000 },
                "1Gb+TV 패밀리": { "인터넷 명의자 사은품": { "유심": 360000 }, "가족 사은품": 120000 }
            },
            "90K 요금제": {
                "100Mb 단독 일반": { "인터넷 명의자 사은품": { "유심": 310000 }, "가족 사은품": "제공 불가" },
                "100Mb 단독 패밀리": { "인터넷 명의자 사은품": { "유심": 310000 }, "가족 사은품": "제공 불가" },
                "500Mb 단독 일반": { "인터넷 명의자 사은품": { "유심": 320000 }, "가족 사은품": "제공 불가" },
                "500Mb 단독 패밀리": { "인터넷 명의자 사은품": { "유심": 320000 }, "가족 사은품": "제공 불가" },
                "1Gb 단독 일반": { "인터넷 명의자 사은품": { "유심": 330000 }, "가족 사은품": "제공 불가" },
                "1Gb 단독 패밀리": { "인터넷 명의자 사은품": { "유심": 330000 }, "가족 사은품": "제공 불가" },
                "100Mb+TV 일반": { "인터넷 명의자 사은품": { "유심": 360000 }, "가족 사은품": 130000 },
                "100Mb+TV 패밀리": { "인터넷 명의자 사은품": { "유심": 360000 }, "가족 사은품": 130000 },
                "500Mb+TV 일반": { "인터넷 명의자 사은품": { "유심": 380000 }, "가족 사은품": 140000 },
                "500Mb+TV 패밀리": { "인터넷 명의자 사은품": { "유심": 380000 }, "가족 사은품": 130000 },
                "1Gb+TV 일반": { "인터넷 명의자 사은품": { "유심": 400000 }, "가족 사은품": 140000 },
                "1Gb+TV 패밀리": { "인터넷 명의자 사은품": { "유심": 400000 }, "가족 사은품": 130000 }
            }
        };
          
        // (Request 4: Installation fees remain VAT included as they are typically charged that way)
        const ktInstallationFees_new = {
            "weekday": {
                "internet_only": { "description": "인터넷 단독", "cost": 36000 },
                "internet_tv": { "description": "인터넷 + TV", "cost": 56200 },
                "internet_landline": { "description": "인터넷 + 일반전화", "cost": 68000 },
                "internet_voip": { "description": "인터넷 + 070전화", "cost": 60000 },
                "internet_tv_landline": { "description": "인터넷 + TV + 일반전화", "cost": 88200 },
                "internet_tv_voip": { "description": "인터넷 + TV + 070전화", "cost": 80200 },
                "internet_tv_additional_tv": { "description": "인터넷 + TV + TV 추가", "cost": 71600 }
            },
            "weekend_night": {
                "internet_only": { "description": "인터넷 단독 (주말/야간)", "cost": 45000 },
                "internet_tv": { "description": "인터넷 + TV (주말/야간)", "cost": 71250 },
                "internet_landline": { "description": "인터넷 + 일반전화 (주말/야간)", "cost": 86000 },
                "internet_voip": { "description": "인터넷 + 070전화 (주말/야간)", "cost": 78000 },
                "internet_tv_landline": { "description": "인터넷 + TV + 일반전화 (주말/야간)", "cost": 112250 },
                "internet_tv_voip": { "description": "인터넷 + TV + 070전화 (주말/야간)", "cost": 104250 },
                "internet_tv_additional_tv": { "description": "인터넷 + TV + TV 추가 (주말/야간)", "cost": 90500 }
            }
        };
          
        // Gifts remain as cash amounts (no VAT applicable)
        const ottCommissionRules_KT = {
            "internet_tv": {
                "description": "KT 인터넷 + TV 결합 상품 정책 (OTT 6종 3년 무료 혜택 제공)",
                "general_notes": [ "1기가 인터넷 접수 시 판매자 수수료에 10,000원 추가" ],
                "commission_rules": [
                    { "commission": 80000, "support_money_min": 350000, "support_money_max": 400000, "plan_tier": "premium", "plan_names": "지니 TV 에센스", "notes": [] },
                    { "commission": 70000, "support_money_min": 350000, "support_money_max": 400000, "plan_tier": "basic", "plan_names": "지니 TV 베이직", "notes": [] },
                    { "commission": 70000, "support_money_min": 410000, "support_money_max": 440000, "plan_tier": "premium", "plan_names": "지니 TV 에센스", "notes": [ "지원금 430,000원까지는 OTT 혜택 제공 가능", "지원금 440,000원부터는 OTT 포함 시 수수료 10,000원 차감" ] },
                    { "commission": 60000, "support_money_min": 410000, "support_money_max": 440000, "plan_tier": "basic", "plan_names": "지니 TV 베이직", "notes": [ "지원금 430,000원까지는 OTT 혜택 제공 가능", "지원금 440,000원부터는 OTT 포함 시 수수료 10,000원 차감" ] },
                    { "commission": 60000, "support_money_min": 450000, "support_money_max": 500000, "plan_tier": "premium", "plan_names": "지니 TV 에센스", "notes": [ "기본적으로 OTT 혜택 미포함", "OTT 포함 시 수수료 10,000원 차감" ] },
                    { "commission": 30000, "support_money_min": 450000, "support_money_max": 500000, "plan_tier": "basic", "plan_names": "지니 TV 베이직", "notes": [ "기본적으로 OTT 혜택 미포함", "OTT 포함 시 수수료 10,000원 차감" ] },
                    { "commission": 30000, "support_money_min": 510000, "support_money_max": 550000, "plan_tier": "premium", "plan_names": "지니 TV 에센스", "notes": [ "기본적으로 OTT 혜택 미포함", "OTT 포함 시 수수료 10,000원 차감" ] },
                    { "commission": 20000, "support_money_min": 510000, "support_money_max": 550000, "plan_tier": "basic", "plan_names": "지니 TV 베이직", "notes": [ "기본적으로 OTT 혜택 미포함", "OTT 포함 시 수수료 10,000원 차감" ] }
                ]
            },
            "internet_only": {
                "description": "KT 인터넷 단독 상품 정책 (500메가 기준, OTT 6종 3년 무료 혜택 제공)",
                "general_notes": [],
                "commission_rules": [
                    { "commission": 60000, "support_money": 110000, "payout_method": "상품권 40,000원 + 현금 70,000원" },
                    { "commission": 40000, "support_money_min": 140000, "support_money_max": 180000, "payout_method": "상품권 40,000원 + 나머지 현금" },
                    { "commission": 30000, "support_money_min": 200000, "support_money_max": 250000, "payout_method": "상품권 40,000원 + 나머지 현금" }
                ]
            }
        };

        const giftTable = {
            "베이직": {
                "100단독": { cash: 50000, voucher: 40000 }, "500단독": { cash: 100000, voucher: 40000 }, "1G단독": { cash: 90000, voucher: 50000 },
                "100번들": { cash: 310000, voucher: 60000 }, "500번들": { cash: 390000, voucher: 60000 }, "기가번들": { cash: 360000, voucher: 90000 }
            },
            "라이트": {
                "100단독": { cash: 50000, voucher: 40000 }, "500단독": { cash: 100000, voucher: 40000 }, "1G단독": { cash: 90000, voucher: 50000 },
                "100번들": { cash: 310000, voucher: 60000 }, "500번들": { cash: 380000, voucher: 70000 }, "기가번들": { cash: 350000, voucher: 100000 }
            },
            "에센스": {
                "100단독": { cash: 50000, voucher: 40000 }, "500단독": { cash: 100000, voucher: 40000 }, "1G단독": { cash: 90000, voucher: 50000 },
                "100번들": { cash: 310000, voucher: 60000 }, "500번들": { cash: 420000, voucher: 30000 }, "기가번들": { cash: 320000, voucher: 30000 }
            },
            "에센스 플러스": {
                "100단독": { cash: 50000, voucher: 40000 }, "500단독": { cash: 100000, voucher: 40000 }, "1G단독": { cash: 90000, voucher: 50000 },
                "100번들": { cash: 310000, voucher: 60000 }, "500번들": { cash: 420000, voucher: 30000 }, "기가번들": { cash: 320000, voucher: 30000 }
            },
            "넷플릭스 HD": {
                "100단독": { cash: 50000, voucher: 40000 }, "500단독": { cash: 100000, voucher: 40000 }, "1G단독": { cash: 90000, voucher: 50000 },
                "100번들": { cash: 310000, voucher: 60000 }, "500번들": { cash: 390000, voucher: 60000 }, "기가번들": { cash: 360000, voucher: 90000 }
            },
            "넷플릭스 UHD": {
                "100단독": { cash: 50000, voucher: 40000 }, "500단독": { cash: 100000, voucher: 40000 }, "1G단독": { cash: 90000, voucher: 50000 },
                "100번들": { cash: 310000, voucher: 60000 }, "500번들": { cash: 390000, voucher: 60000 }, "기가번들": { cash: 360000, voucher: 90000 }
            },
            "키즈랜드": {
                "100단독": { cash: 50000, voucher: 40000 }, "500단독": { cash: 100000, voucher: 40000 }, "1G단독": { cash: 90000, voucher: 50000 },
                "100번들": { cash: 310000, voucher: 60000 }, "500번들": { cash: 390000, voucher: 60000 }, "기가번들": { cash: 360000, voucher: 90000 }
            }
        };
          
        // (Request 4: Mobile discounts remain VAT included as they apply to VAT-included mobile bills)
        const kt_total_mobile_fee_discounts = {
            "100M": {
                "tier1_under_22000": { "internet_discount": 1650, "mobile_discount": 0, "total_discount": 1650 },
                "tier2_22000_to_64899": { "internet_discount": 3300, "mobile_discount": 0, "total_discount": 3300 },
                "tier3_64900_to_108899": { "internet_discount": 5500, "mobile_discount": 3300, "total_discount": 8800 },
                "tier4_108900_to_141899": { "internet_discount": 5500, "mobile_discount": 14300, "total_discount": 19800 },
                "tier5_141900_to_174899": { "internet_discount": 5500, "mobile_discount": 18700, "total_discount": 24200 },
                "tier6_over_174900": { "internet_discount": 5500, "mobile_discount": 23100, "total_discount": 28600 }
            },
            "500M_1G": {
                "tier1_under_22000": { "internet_discount": 2200, "mobile_discount": 0, "total_discount": 2200 },
                "tier2_22000_to_64899": { "internet_discount": 5500, "mobile_discount": 0, "total_discount": 5500 },
                "tier3_64900_to_108899": { "internet_discount": 5500, "mobile_discount": 5500, "total_discount": 11000 },
                "tier4_108900_to_141899": { "internet_discount": 5500, "mobile_discount": 16610, "total_discount": 22110 },
                "tier5_141900_to_174899": { "internet_discount": 5500, "mobile_discount": 22100, "total_discount": 27610 },
                "tier6_over_174900": { "internet_discount": 5500, "mobile_discount": 27610, "total_discount": 33110 }
            }
        };
          
          
        // ------------------- DOM Element Selectors -------------------
        const internetPlanEl = document.getElementById('internetPlan');
        const wifiRouterRentalEl = document.getElementById('wifiRouterRental');
        const tvPlanEl = document.getElementById('tvPlan');
        const additionalTvPlanEl = document.getElementById('additionalTvPlan');
        const phonePlanEl = document.getElementById('phonePlan');
        const addonServicesContainerEl = document.getElementById('addonServicesContainer');
        const mobileLinesCountEl = document.getElementById('mobileLinesCount');
        const mobileLinesContainerEl = document.getElementById('mobileLinesContainer');
        const dongpanSalesCheckKtEl = document.getElementById('dongpanSalesCheckKt');
        const dongpanPolicyDetailsContainerKtEl = document.getElementById('dongpanPolicyDetailsContainerKt');
        const discountTypeRadios = document.querySelectorAll('input[name="discountType"]');
          
        const totalAmountDetailsToggleEl = document.getElementById('totalAmountDetailsToggle');
        const totalAmountDetailsContainerEl = document.getElementById('totalAmountDetailsContainer');
          
        const fixedRateDetailsToggleEl = document.getElementById('fixedRateDetailsToggle');
        const fixedRateDetailsContainerEl = document.getElementById('fixedRateDetailsContainer');
      
        const premiumFamilyDetailsToggleEl = document.getElementById('premiumFamilyDetailsToggle');
        const premiumFamilyDetailsContainerEl = document.getElementById('premiumFamilyDetailsContainer');
          
        const premiumSingleDetailsToggleEl = document.getElementById('premiumSingleDetailsToggle');
        const premiumSingleDetailsContainerEl = document.getElementById('premiumSingleDetailsContainer');
          
        const familyBundleDetailsToggleEl = document.getElementById('familyBundleDetailsToggle');
        const familyBundleDetailsContainerEl = document.getElementById('familyBundleDetailsContainer');
          
        const separateFamilyDetailsToggleEl = document.getElementById('separateFamilyDetailsToggle');
        const separateFamilyDetailsContainerEl = document.getElementById('separateFamilyDetailsContainer');
          
        const mvnoDetailsToggleEl = document.getElementById('mvnoDetailsToggle');
        const mvnoDetailsContainerEl = document.getElementById('mvnoDetailsContainer');
          
        const calculateButton = document.getElementById('calculateButton');
        const resetButton = document.getElementById('resetButton');
        const resultSection = document.getElementById('resultSection');
          
        const toggleDetailsButton = document.getElementById('toggleDetailsButton');
        const expandedDetailsContainer = document.getElementById('expandedDetailsContainer');
          
        const summaryPreDiscountCostEl = document.getElementById('summaryPreDiscountCost');
        const summaryFinalCostEl = document.getElementById('summaryFinalCost');
        const summaryInternetDiscountEl = document.getElementById('summaryInternetDiscount');
        const summaryGiftTotalEl = document.getElementById('summaryGiftTotal');
        const summaryMobileDiscountEl = document.getElementById('summaryMobileDiscount');
          
        const selectedInternetEl = document.getElementById('selectedInternet');
        const selectedTvEl = document.getElementById('selectedTv');
        const selectedAdditionalTvEl = document.getElementById('selectedAdditionalTv');
        const selectedPhoneEl = document.getElementById('selectedPhone');
        const selectedWifiEl = document.getElementById('selectedWifi');
        const selectedMobileCountEl = document.getElementById('selectedMobileCount');
        const selectedDiscountTypeEl = document.getElementById('selectedDiscountType');
        const selectedWifiDetailsEl = document.getElementById('selectedWifiDetails');
          
          
        const detailInternetBaseEl = document.getElementById('detailInternetBase');
        const detailWifiFeeEl = document.getElementById('detailWifiFee');
        const detailInternetDiscountTotalEl = document.getElementById('detailInternetDiscountTotal');
        // (Request 4: Added Pre-VAT and VAT elements)
        const detailFinalCostPreVatEl = document.getElementById('detailFinalCostPreVat');
        const detailVatAmountEl = document.getElementById('detailVatAmount');
        const detailFinalCostEl = document.getElementById('detailFinalCost');
          
        const giftCashEl = document.getElementById('giftCash');
        const giftVoucherEl = document.getElementById('giftVoucher');
        const giftPhoneVoucherEl = document.getElementById('giftPhoneVoucher');
        const giftAdditionalTvEl = document.getElementById('giftAdditionalTv');
        const dongpanCashContainerKtEl = document.getElementById('dongpanCashContainerKt');
        const giftDongpanAdditionalCashKtEl = document.getElementById('giftDongpanAdditionalCashKt');
        const giftTotalEl = document.getElementById('giftTotal');
        const mobileDiscountDetailContainerEl = document.getElementById('mobileDiscountDetailContainer');
          
        // --- New selectors for installation fee ---
        const installationFeeSectionEl = document.getElementById('installationFeeSection');
        const installationFeeResultEl = document.getElementById('installationFeeResult');
        const installationFeeDescriptionEl = document.getElementById('installationFeeDescription');
          
        // --- Message Script Selectors ---
        const messageScriptSectionEl = document.getElementById('messageScriptSection');
        const memoScriptEl = document.getElementById('memoScript');
        const infoScriptEl = document.getElementById('infoScript');
        const completeScriptEl = document.getElementById('completeScript');
        const sensitiveInfoLinkScriptEl = document.getElementById('sensitiveInfoLinkScript');
        const usimCompleteScriptEl = document.getElementById('usimCompleteScript');
        const tcoComparisonScriptEl = document.getElementById('tcoComparisonScript');
        const penaltyAnalysisScriptEl = document.getElementById('penaltyAnalysisScript');
        const penaltyWaiverScriptEl = document.getElementById('penaltyWaiverScript');
          
        // (Request 2: Removed Gemini API related selectors)
      
        // ✨ New Button Selector
        const generateComparisonButtonEl = document.getElementById('generateComparisonButton');
        const generateDiscountTypeComparisonButtonEl = document.getElementById('generateDiscountTypeComparisonButton');
      
        const affiliateCardEl = document.getElementById('affiliateCard');
        const cardTierContainerEl = document.getElementById('cardTierContainer');
        const cardTiersEl = document.getElementById('cardTiers');
        const summaryCardAppliedEl = document.getElementById('summaryCardApplied');
        const detailCardDiscountContainerEl = document.getElementById('detailCardDiscountContainer');
        const selectedCardNameEl = document.getElementById('selectedCardName');
        const detailCardDiscountEl = document.getElementById('detailCardDiscount');
        const detailFinalCardCostContainerEl = document.getElementById('detailFinalCardCostContainer');
        const detailFinalCardCostEl = document.getElementById('detailFinalCardCost');
        const finalCardCostSeparatorEl = document.getElementById('finalCardCostSeparator');
          
        // ------------------- Event Listeners -------------------
        mobileLinesCountEl.addEventListener('input', updateMobileLinesInputs);
        calculateButton.addEventListener('click', calculateAndDisplayResults);
        resetButton.addEventListener('click', resetCalculator);
      
        affiliateCardEl.addEventListener('change', () => {
            const selectedCard = affiliateCardEl.value;
            cardTiersEl.innerHTML = ''; // Clear previous options
      
            if (selectedCard === 'none') {
                cardTierContainerEl.classList.add('hidden');
                return;
            }
      
            const cardData = affiliateCardDiscounts[selectedCard];
            if (cardData) {
                cardData.tiers.forEach((tier, index) => {
                    const label = document.createElement('label');
                    label.className = 'radio-label';
                    label.innerHTML = `
                        <input type="radio" name="cardTier" value="${tier.discount}" class="radio-input" ${index === 0 ? 'checked' : ''}>
                        ${tier.label} (월 ${tier.discount.toLocaleString()}원 할인)
                    `;
                    cardTiersEl.appendChild(label);
                });
                cardTierContainerEl.classList.remove('hidden');
            }
        });
      
        if (generateComparisonButtonEl) {
            generateComparisonButtonEl.addEventListener('click', generateComparisonScript);
        }
      
        if (generateDiscountTypeComparisonButtonEl) {
            generateDiscountTypeComparisonButtonEl.addEventListener('click', generateDiscountTypeComparisonScript);
        }
          
        toggleDetailsButton.addEventListener('click', () => {
            expandedDetailsContainer.classList.toggle('hidden');
            const isHidden = expandedDetailsContainer.classList.contains('hidden');
            toggleDetailsButton.innerHTML = isHidden ? '상세 요금 내역 펼쳐보기 ▼' : '상세 요금 내역 접기 ▲';
        });
          
        if(dongpanSalesCheckKtEl) {
            dongpanSalesCheckKtEl.addEventListener('change', function() {
                if (dongpanPolicyDetailsContainerKtEl) {
                    dongpanPolicyDetailsContainerKtEl.classList.toggle('hidden', !this.checked);
                }
                if (!resultSection.classList.contains('hidden')) {
                    calculateAndDisplayResults();
                }
            });
        }
      
        // (Request 2: Removed Gemini API button listeners)
      
        const allDetailSections = [
            { radioValue: 'totalAmountBundle', toggleEl: totalAmountDetailsToggleEl, containerEl: totalAmountDetailsContainerEl, updateFn: updateTotalAmountDetails },
            { radioValue: 'fixedRateBundle', toggleEl: fixedRateDetailsToggleEl, containerEl: fixedRateDetailsContainerEl, updateFn: updateFixedRateDetails },
            { radioValue: 'premiumFamilyBundle', toggleEl: premiumFamilyDetailsToggleEl, containerEl: premiumFamilyDetailsContainerEl, updateFn: updatePremiumFamilyDetails },
            { radioValue: 'premiumSingleBundle', toggleEl: premiumSingleDetailsToggleEl, containerEl: premiumSingleDetailsContainerEl, updateFn: updatePremiumSingleDetails },
            { radioValue: 'familyBundle', toggleEl: familyBundleDetailsToggleEl, containerEl: familyBundleDetailsContainerEl, updateFn: updateFamilyBundleDetails },
            { radioValue: 'separateFamilyBundle', toggleEl: separateFamilyDetailsToggleEl, containerEl: separateFamilyDetailsContainerEl, updateFn: updateSeparateFamilyDetails },
            { radioValue: 'mvnoBundle', toggleEl: mvnoDetailsToggleEl, containerEl: mvnoDetailsContainerEl, updateFn: updateMvnoDetails }
        ];
          
        function updateMobilePlanOptions() {
            const selectedDiscountType = document.querySelector('input[name="discountType"]:checked').value;
             
            document.querySelectorAll('.mobile-plan-select').forEach((select, index) => {
                let isPremiumLineRuleActive = (selectedDiscountType === 'premiumFamilyBundle' && index < 2) || selectedDiscountType === 'premiumSingleBundle';
                let needsReset = false;
      
                for (const option of select.options) {
                    const price = parseInt(option.value);
                    if (price > 0) {
                        if (isPremiumLineRuleActive && price < 77000) {
                            option.disabled = true;
                            if (option.selected) {
                                needsReset = true;
                            }
                        } else {
                            option.disabled = false;
                        }
                    }
                }
      
                if (needsReset) {
                    const firstAvailablePremium = Array.from(select.options).find(opt => !opt.disabled && parseInt(opt.value) >= 77000);
                    if (firstAvailablePremium) {
                            select.value = firstAvailablePremium.value;
                    } else {
                            select.value = "0";
                    }
                    select.dispatchEvent(new Event('change'));
                }
            });
        }
          
        function updateInternetPlanOptions() {
            const selectedDiscountType = document.querySelector('input[name="discountType"]:checked').value;
            const restrictedTypes = ['separateFamilyBundle', 'premiumFamilyBundle', 'premiumSingleBundle'];
            const isRestricted = restrictedTypes.includes(selectedDiscountType);
      
            let wasChanged = false;
      
            for (const option of internetPlanEl.options) {
                if (!option.dataset.speed) continue;
                const speed = parseInt(option.dataset.speed);
                if (speed < 500) { // 500M 미만(즉, 100M)을 제한
                    if (isRestricted) {
                        option.disabled = true;
                        if (option.selected) {
                            internetPlanEl.value = 'none';
                            wasChanged = true;
                        }
                    } else {
                        option.disabled = false;
                    }
                }
            }
      
            if (wasChanged) {
                const first500M = Array.from(internetPlanEl.options).find(opt => parseInt(opt.dataset.speed) === 500 && !opt.disabled);
                if (first500M) {
                    internetPlanEl.value = first500M.value;
                }
                internetPlanEl.dispatchEvent(new Event('change'));
            }
        }
          
        discountTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                const newlySelectedRadioValue = this.value;
                const oldMobileCount = parseInt(mobileLinesCountEl.value);
      
                allDetailSections.forEach(section => {
                    if (section.containerEl && section.toggleEl) {
                        let isVisible = false;
                        if (newlySelectedRadioValue === section.radioValue) {
                            isVisible = section.toggleEl.checked;
                            if (isVisible && section.updateFn) {
                                section.updateFn();
                            }
                        } else {
                            section.toggleEl.checked = false;
                            isVisible = false;
                        }
                        section.containerEl.classList.toggle('hidden', !isVisible);
                    }
                });
      
                if (newlySelectedRadioValue === 'premiumSingleBundle') {
                    mobileLinesCountEl.value = 1;
                    mobileLinesCountEl.disabled = true;
                } else if (newlySelectedRadioValue === "none" || newlySelectedRadioValue === "familyBundle" || newlySelectedRadioValue === "mvnoBundle") {
                    mobileLinesCountEl.value = 0;
                    mobileLinesCountEl.disabled = true;
                } else {
                    mobileLinesCountEl.disabled = false;
                        if (oldMobileCount === 0 && !mobileLinesCountEl.disabled) {
                            mobileLinesCountEl.value = 1;
                        } else {
                            mobileLinesCountEl.value = oldMobileCount;
                        }
                }
      
                updateMobileLinesInputs();
                 
                updateMobilePlanOptions();
                updateInternetPlanOptions();
            });
        });
          
          
        allDetailSections.forEach(section => {
            if (section.toggleEl && section.containerEl && section.updateFn) {
                section.toggleEl.addEventListener('change', function() {
                    const radioForThisToggle = document.querySelector(`input[name="discountType"][value="${section.radioValue}"]`);
                    if (radioForThisToggle && radioForThisToggle.checked) {
                        section.containerEl.classList.toggle('hidden', !this.checked);
                        if (this.checked) {
                            section.updateFn();
                        }
                    } else {
                        section.containerEl.classList.add('hidden');
                        this.checked = false;
                    }
                });
            }
        });
      
        const internetTypeRadios = document.querySelectorAll('input[name="internetType"]');
        internetTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                populateInternetPlans();
                handleInternetTypeChange();
            });
        });
          
          
        // ------------------- Functions -------------------
          
        function populateInternetPlans() {
            const selectedInternetType = document.querySelector('input[name="internetType"]:checked').value;
            const currentInternetPlan = internetPlanEl.value;
            internetPlanEl.innerHTML = '<option value="none">선택 안함</option>';

            for (const planKey in internetPlans_KT) {
                const plan = internetPlans_KT[planKey];
                let displayText = "";
                let matchesType = false;

                // Skip OTT plans for speeds less than 500M
                if (plan.isOttPlan && plan.speed < 500) {
                    continue;
                }

                const speedText = plan.speed >= 1000 ? `${plan.speed / 1000}G` : `${plan.speed}M`;
                const ottText = plan.isOttPlan ? "+OTT 6종 3년 무료" : "";

                if (selectedInternetType === "bundle") {
                    if (planKey.includes("번들")) {
                        displayText = `인터넷 ${speedText}${ottText} (TV 결합 시) (월 ${plan.basePrice.toLocaleString()}원, VAT별도)`;
                        matchesType = true;
                    }
                } else {
                    if (planKey.includes("(단독)")) {
                        displayText = `인터넷(단독) ${speedText}${ottText} (월 ${plan.basePrice.toLocaleString()}원, VAT별도)`;
                        matchesType = true;
                    }
                }

                if (matchesType) {
                    const option = document.createElement('option');
                    option.value = planKey;
                    option.textContent = displayText;
                    option.dataset.price = plan.basePrice;
                    option.dataset.speed = plan.speed;
                    option.dataset.type = plan.type;
                    if (plan.isOttPlan) {
                        option.dataset.isOttPlan = "true";
                    }
                    internetPlanEl.appendChild(option);
                }
            }

            if (Array.from(internetPlanEl.options).some(opt => opt.value === currentInternetPlan)) {
                internetPlanEl.value = currentInternetPlan;
            }

            updateInternetPlanOptions();
            internetPlanEl.dispatchEvent(new Event('change'));
        }
          
        function handleInternetTypeChange() {
            const selectedInternetType = document.querySelector('input[name="internetType"]:checked').value;
            const isStandalone = selectedInternetType === 'standalone';
      
            tvPlanEl.disabled = isStandalone;
            additionalTvPlanEl.disabled = isStandalone;
      
            if (isStandalone) {
                tvPlanEl.value = "none";
                additionalTvPlanEl.value = "none";
                // Set default standalone plan if current selection is invalid
                if (!internetPlanEl.value.includes("(단독)")) {
                    internetPlanEl.value = "KT인터넷(단독) 100mb";
                }
            } else {
                // Set default bundle plan if current selection is invalid
                if (!internetPlanEl.value.includes("번들")) {
                    internetPlanEl.value = "KT인터넷번들100mb";
                }
      
                if (tvPlanEl.value === "none") {
                    tvPlanEl.value = "KTTV베이직";
                }
            }
            tvPlanEl.dispatchEvent(new Event('change'));
            internetPlanEl.dispatchEvent(new Event('change'));
        }
          
          
        internetPlanEl.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
             
            wifiRouterRentalEl.disabled = false;
            const ktRouterOption = Array.from(wifiRouterRentalEl.options).find(opt => opt.dataset.name === "KT공유기");
            if (ktRouterOption) {
                // (Request 4: Updated display price)
                ktRouterOption.textContent = 'KT공유기 (월 1,000원)';
            }
      
            if (!selectedOption || selectedOption.value === 'none') {
                updateDiscountTypeAvailability();
                return;
            }
      
            const internetSpeed = parseInt(selectedOption.dataset.speed);
             
            if (internetSpeed >= 1000) { 
                if (ktRouterOption) {
                    ktRouterOption.selected = true;
                    ktRouterOption.textContent = 'KT공유기 (1G 이상 무료)';
                    wifiRouterRentalEl.disabled = true;
                }
            } 
            updateDiscountTypeAvailability();
        });
          
          
        tvPlanEl.addEventListener('change', () => {
            const isTvSelected = tvPlanEl.value !== 'none';
        });
          
        additionalTvPlanEl.addEventListener('change', () => {
            if (tvPlanEl.value === 'none' && additionalTvPlanEl.value !== 'none') {
                additionalTvPlanEl.value = 'none';
            }
        });
          

        // !!! FIX: Refactored updateMobileLinesInputs function !!!
        function updateMobileLinesInputs() {
            const count = parseInt(mobileLinesCountEl.value) || 0;
            const selectedDiscountType = document.querySelector('input[name="discountType"]:checked').value;

            // 1. Capture current state (including checkbox)
            const currentState = [];
            document.querySelectorAll('.mobile-line-item').forEach((item, i) => {
                const select = item.querySelector(`#mobilePlan${i}`);
                const checkbox = item.querySelector(`#selectiveContract${i}`);
                if (select && checkbox) {
                    currentState.push({
                        value: select.value,
                        checked: checkbox.checked
                    });
                }
            });

            mobileLinesContainerEl.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = 'mobile-line-item py-2 space-y-2';
                div.innerHTML = `
                    <div>
                        <label for="mobilePlan${i}" class="block text-sm font-medium text-slate-600 mb-1">회선 ${i + 1} 요금제 선택</label>
                        <div class="flex items-center space-x-2">
                            <label for="selectiveContract${i}" class="flex items-center text-sm font-medium text-slate-600 cursor-pointer hover:text-sky-600 p-2 rounded-md bg-slate-50 border border-slate-200">
                                <input type="checkbox" id="selectiveContract${i}" class="selective-contract-checkbox radio-input h-4 w-4 mr-2">
                                선택약정
                            </label>
                            <select id="mobilePlan${i}" class="input-field mobile-plan-select flex-grow">
                                <option value="0" data-name="요금제 선택없음" data-url="">요금제 선택없음</option>
                                ${mobilePlans_KT.map(plan => `
                                    <option value="${plan.price}" data-name="${plan.name}" data-url="${plan.url}">
                                        ${plan.name} (${plan.price.toLocaleString()}원)
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                `;
                mobileLinesContainerEl.appendChild(div);

                const newSelect = document.getElementById(`mobilePlan${i}`);
                const newCheckbox = document.getElementById(`selectiveContract${i}`);

                // 2. Determine the value to set (Prioritize existing state, then defaults)
                let valueToSet = currentState[i] ? currentState[i].value : "0";
                let checkedState = currentState[i] ? currentState[i].checked : false;

                // Apply defaults only if the line is new or the existing value is "0"
                if (valueToSet === "0") {
                    if (selectedDiscountType === 'premiumFamilyBundle') {
                        if (i === 0) valueToSet = "80000"; // Assuming first line should also default if not set
                        else if (i === 1) valueToSet = "80000";
                        else if (i > 1) valueToSet = "69000";
                    } else if (selectedDiscountType === 'premiumSingleBundle') {
                        if (i === 0) valueToSet = "80000";
                    }
                }
                 
                // 3. Set the value and state
                if (newSelect.querySelector(`option[value="${valueToSet}"]`)) {
                   newSelect.value = valueToSet;
                } else {
                   // Fallback if the previously selected value is no longer valid (e.g., due to restrictions)
                   newSelect.value = "0"; 
                }
                newCheckbox.checked = checkedState;
            }

            // 4. Add event listeners and update availability
            document.querySelectorAll('.mobile-plan-select, .selective-contract-checkbox').forEach(el => {
                el.addEventListener('change', () => {
                    const currentDiscountType = document.querySelector('input[name="discountType"]:checked').value;
                    const section = allDetailSections.find(s => s.radioValue === currentDiscountType);
                    if (section && section.toggleEl.checked && section.updateFn) {
                        section.updateFn();
                    }
                    updateDiscountTypeAvailability();
                });
            });

            updateMobilePlanOptions();
            updateDiscountTypeAvailability();
        }
          
          
        function getSelectedInternetInfo(planName) {
            if (!planName || planName === 'none' || !internetPlans_KT[planName]) {
                return { basePrice: 0, modemFee: 0, type: "none", speed: 0 };
            }
      
            let basePrice = internetPlans_KT[planName].basePrice;
            // Note: The logic below seems redundant as the basePrice is already defined correctly in the constant based on the planName key.
            // const selectedOption = Array.from(internetPlanEl.options).find(opt => opt.value === planName);
            // if (selectedOption && selectedOption.value !== 'none' && selectedOption.text.includes("KT인터넷번들")) {
            //     basePrice = internetPlans_KT[planName].basePrice;
            // }
      
            return { ...internetPlans_KT[planName], basePrice: basePrice };
        }
          
        function getMobileTierKey(totalMobileBaseCost, numMobileLines, internetSpeedType) {
            const discountType = document.querySelector('input[name="discountType"]:checked').value;
            if (numMobileLines > 0 && totalMobileBaseCost === 0 && discountType === 'totalAmountBundle') {
                 totalMobileBaseCost = 37000;
            }
            if (numMobileLines === 0 || totalMobileBaseCost === 0) return null;
      
            if (internetSpeedType === "100M") {
                if (totalMobileBaseCost < 22000) return "모바일_22000미만";
                if (totalMobileBaseCost < 64900) return "모바일_64900미만";
                return "모바일_64900이상";
            } else {
                if (totalMobileBaseCost < 22000) return "모바일_22000미만";
                return "모바일_22000이상";
            }
        }
          
        function getMobileTierKeyFor500MUp(totalMobileBaseCost, numMobileLines){
            if (numMobileLines === 0 || totalMobileBaseCost === 0) return null;
            if (totalMobileBaseCost < 22000) return "모바일_22000미만";
            return "모바일_22000이상";
        }
          
        function getMobileTierKeyForSeparateFamily(totalMobileBaseCost, numMobileLines){
            if (numMobileLines === 0 || totalMobileBaseCost === 0) return null;
            if (totalMobileBaseCost < 22000) return "모바일_22000미만";
            return "모바일_22000이상";
        }
          
        // --- NEW/MODIFIED FUNCTIONS for Discount Details ---
      
        function copyDiscountDetailsToClipboard(type) {
            let textToCopy = '';
            switch(type) {
                case 'totalAmountBundle':
                    textToCopy = `[KT 총액 결합할인 안내]
    KT 휴대폰을 쓰는 가족이 많을수록, 요금 총액이 높을수록 유리한 결합입니다.
      
    ■ 핵심 혜택 (인터넷+모바일)
    - 100M: 최대 28,600원 할인
    - 500M/1G: 최대 33,110원 할인
    * 할인액은 결합하는 휴대폰 요금 총액에 따라 달라집니다.
      
    ■ 주요 조건
    - 최대 인터넷 1회선 + 휴대폰 5회선까지 결합 가능
    - 대표자 기준 직계 가족 범위만 가능 (가족관계증명서 필요)
      
    ■ 주의사항
    - 기존 '무선무선' 휴대폰 결합과는 중복 불가합니다.`;
                    break;
                case 'fixedRateBundle':
                    textToCopy = `[KT 정액 결합할인 안내]
    인터넷과 휴대폰을 간단하게 결합하고 싶을 때 좋은 선택입니다.
      
    ■ 핵심 혜택
    - 인터넷 요금: 5,500원 할인
    - 휴대폰 요금: 월정액 총액에 따라 최대 7,000원 추가 할인
      
    ■ 특별 혜택!
    - 500Mbps 이상 인터넷만 단독으로 가입 시, 'TM결합할인(5,500원)'이 중복 적용되어 인터넷에서만 총 11,000원 할인됩니다.
      
    ■ 주요 조건
    - 인터넷 1회선 + 휴대폰 10회선까지 결합 가능
      
    ■ 주의사항
    - 인터넷+TV 번들 상품의 경우 인터넷 할인 5,500원만 적용됩니다.
    - 패밀리 자회선 할인과 인터넷 할인은 중복 적용되지 않습니다.`;
                    break;
                case 'premiumFamilyBundle':
                    textToCopy = `[KT 프리미엄 가족결합 안내]
    고가 요금제(7.7만 이상) 쓰는 가족이 2명 이상일 때 강력 추천하는 결합입니다.
      
    ■ 핵심 혜택
    - 2번째 회선부터 7.7만 이상 요금제는 월정액의 25% 할인! (선택약정과 중복 시 최대 50%!)
    - 1번째 회선은 '총액결합할인'으로 추가 할인 적용
      
    ■ 주요 조건
    - 500M 이상 인터넷 사용 필수
    - 결합 가족 중 2명 이상이 7.7만 원 이상 요금제 사용
      
    ■ 주의사항
    - 100M 인터넷은 가입 불가합니다.
    - 할인을 한 명에게 몰아줄 수는 없습니다.`;
                    break;
                case 'premiumSingleBundle':
                    textToCopy = `[KT 프리미엄 싱글결합 안내]
    혼자서 고가 요금제(7.7만 이상)와 빠른 인터넷을 쓸 때 최고의 선택입니다.
      
    ■ 핵심 혜택
    - 휴대폰 요금 월정액의 25% 할인 (선택약정과 중복 시 최대 50%!)
    - 500M 이상 인터넷 단독 사용 시 5,500원 추가 할인
      
    ■ 주요 조건
    - 500M 이상 인터넷 사용 필수
    - 본인 휴대폰 1회선이 7.7만 원 이상 요금제 사용
      
    ■ 주의사항
    - 100M 인터넷은 가입 불가합니다.
    - 인터넷+TV 결합 시에는 가입이 제한될 수 있습니다.`;
                    break;
                case 'familyBundle':
                    textToCopy = `[KT 패밀리 결합 안내]
    기존에 KT 인터넷을 쓰는 가족이 있을 때, 추가 회선을 저렴하게 이용하는 방법입니다.
      
    ■ 핵심 혜택 (추가 회선 기준)
    - 100M 인터넷: 5,500원 할인
    - 500M/1G 인터넷: 11,000원 할인
      
    ■ 주요 조건
    - 본인 또는 직계 가족 중 기존 KT 인터넷 사용자(모회선) 필요
    - 신규 설치 후 1개월 내 결합 신청 필수
      
    ■ 주의사항
    - 법인 명의는 가입 불가합니다.`;
                    break;
                case 'separateFamilyBundle':
                    textToCopy = `[KT 따로 살아도 가족결합 안내]
    멀리 사는 가족도 KT 인터넷을 쓴다면 추가 할인을 받을 수 있는 새로운 결합 상품입니다.
      
    ■ 핵심 혜택
    - 500M 인터넷/TV: 각각 2,200원 추가 할인
    - 1G 인터넷/TV: 각각 3,300원 추가 할인
    * 기존 '총액 결합할인'과 중복 적용됩니다.
      
    ■ 주요 조건
    - 기준 가족(베이스 회선)이 KT 인터넷+휴대폰 사용
    - 25년 3월 이후 신규 가입자
    - 가족관계증명서 등 서류 제출 필요
      
    ■ 주의사항
    - 100M 인터넷은 할인 혜택이 없습니다.
    - 기존 '뭉치면올레' 사용자는 베이스 회선 지정 불가
    - '패밀리 결합' 자회선은 중복 적용 불가
    - 개통 후 익월 말까지 결합 신청 필수`;
                    break;
                case 'mvnoBundle':
                    textToCopy = `[KT 알뜰폰 결합 안내]
    KT망 알뜰폰 유저를 위한 인터넷 요금 할인 상품입니다.
      
    ■ 핵심 혜택 (인터넷 요금만 할인)
    - 100M: 3,300원 할인
    - 500M/1G(단독): 11,000원 할인
    - 500M/1G(TV결합): 5,500원 할인
      
    ■ 주요 조건
    - 지정된 KT망 알뜰폰 통신사 사용 고객
    - 인터넷 설치 후, 사용 중인 알뜰폰 고객센터로 직접 결합 신청
      
    ■ 주의사항
    - 개인/법인 사업자는 결합 불가합니다.
    - 웹(온라인)을 통해 개통한 알뜰폰만 결합 가능합니다. (우체국, 대리점 개통건 불가)
    - 결합 가능 알뜰폰 통신사: 1. 엠모바일 2. 미니게이트(쉐이크모바일) 3. 유니컴즈(모빙) 4. 토스모바일 5. 국민은행(리브모바일) 6. 더피엔엘 (퍼스트모바일) 7. 에르엘 (오파스넷모바일)
        8. 고고팩토리 9. 스마텔  10. 코드모바일 11. 프리티 12. 니오라코리아 13. 스피츠모바일 14.아이즈비전 15. 스카이라이프(CU관련과 밀리의서재 요금제는 결합이 불가)
        `;
                    break;
            }
             
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('안내 내용이 복사되었습니다.');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                alert('복사에 실패했습니다.');
            });
        }
      
        function updateTotalAmountDetails() {
            totalAmountDetailsContainerEl.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-sky-800 text-base">💸 총액 결합할인</h4>
                    <button onclick="copyDiscountDetailsToClipboard('totalAmountBundle')" class="btn-secondary text-xs py-1 px-2 rounded-md">내용 복사</button>
                </div>
                <p class="text-sm text-sky-700 bg-sky-100 p-2 rounded-md mb-3">
                    "KT 휴대폰 쓰는 가족이 많을수록, 요금 총액이 높을수록 유리해요!"
                </p>
                <div class="mb-3">
                    <h5 class="font-semibold text-slate-700 text-sm mb-1">🎁 핵심 혜택</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-slate-600">
                        <li>인터넷과 모바일 요금을 <strong>이중으로 할인!</strong></li>
                        <li><strong>100M 인터넷 기준:</strong> 최대 <strong class="text-green-600">28,600원</strong> 할인</li>
                        <li><strong>500M/1G 인터넷 기준:</strong> 최대 <strong class="text-green-600">33,110원</strong> 할인</li>
                    </ul>
                </div>
                <div class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded">
                    <h5 class="font-bold text-amber-800 text-sm mb-1">⚠️ 꼭 확인하세요!</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-amber-700">
                        <li>기존 '무선무선' 결합 상품과는 중복 가입이 안돼요.</li>
                        <li>최대 인터넷 1회선 + 휴대폰 5회선까지 결합 가능해요.</li>
                    </ul>
                </div>
            `;
        }
          
        function updateFixedRateDetails() {
            fixedRateDetailsContainerEl.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-teal-800 text-base">💵 정액 결합할인</h4>
                    <button onclick="copyDiscountDetailsToClipboard('fixedRateBundle')" class="btn-secondary text-xs py-1 px-2 rounded-md">내용 복사</button>
                </div>
                <p class="text-sm text-teal-700 bg-teal-100 p-2 rounded-md mb-3">
                    "간단하게 인터넷과 휴대폰 요금을 모두 할인받는 실속형 결합!"
                </p>
                <div class="mb-3">
                    <h5 class="font-semibold text-slate-700 text-sm mb-1">🎁 핵심 혜택</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-slate-600">
                        <li><strong>인터넷 요금:</strong> 기본 <strong class="text-green-600">5,500원</strong> 할인</li>
                        <li><strong>휴대폰 요금:</strong> 월정액 총액 따라 최대 <strong class="text-green-600">7,000원</strong> 추가 할인</li>
                        <li class="font-bold text-blue-600"><strong>✨특별 혜택:</strong> 500M 이상 인터넷만 가입 시, TM할인(5,500원)이 중복 적용되어 인터넷에서만 총 <strong>11,000원 할인!</strong></li>
                    </ul>
                </div>
                <div class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded">
                    <h5 class="font-bold text-amber-800 text-sm mb-1">⚠️ 꼭 확인하세요!</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-amber-700">
                        <li>인터넷+TV 결합 시에는 인터넷 5,500원 할인만 적용돼요.</li>
                        <li>패밀리 자회선 할인과 인터넷 할인은 중복 적용되지 않아요.</li>
                    </ul>
                </div>
            `;
        }
      
        function updatePremiumFamilyDetails() {
            premiumFamilyDetailsContainerEl.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-violet-800 text-base">👑 프리미엄 가족결합</h4>
                    <button onclick="copyDiscountDetailsToClipboard('premiumFamilyBundle')" class="btn-secondary text-xs py-1 px-2 rounded-md">내용 복사</button>
                </div>
                <p class="text-sm text-violet-700 bg-violet-100 p-2 rounded-md mb-3">
                    "고가 요금제(7.7만 이상) 쓰는 가족이 2명 이상일 때 강력 추천!"
                </p>
                <div class="mb-3">
                    <h5 class="font-semibold text-slate-700 text-sm mb-1">🎁 핵심 혜택</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-slate-600">
                        <li>2번째 회선부터 <strong>휴대폰 요금 25% 할인!</strong></li>
                        <li>선택약정 25% + 결합 25% = <strong class="text-green-600">최대 50% 할인!</strong></li>
                        <li>1번째 회선은 '총액결합'으로 추가 할인을 받아요.</li>
                    </ul>
                </div>
                <div class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded">
                    <h5 class="font-bold text-amber-800 text-sm mb-1">⚠️ 꼭 확인하세요!</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-amber-700">
                        <li><strong>500M 이상 인터넷</strong>만 가입 가능해요. (100M 불가)</li>
                        <li>가족 중 <strong>2명 이상이 7.7만 원 이상</strong> 요금제를 써야 해요.</li>
                    </ul>
                </div>
            `;
        }
          
        function updatePremiumSingleDetails() {
            premiumSingleDetailsContainerEl.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-rose-800 text-base">💎 프리미엄 싱글결합</h4>
                    <button onclick="copyDiscountDetailsToClipboard('premiumSingleBundle')" class="btn-secondary text-xs py-1 px-2 rounded-md">내용 복사</button>
                </div>
                <p class="text-sm text-rose-700 bg-rose-100 p-2 rounded-md mb-3">
                    "혼자서 고가 요금제(7.7만 이상)와 빠른 인터넷을 쓸 때 최고의 선택!"
                </p>
                <div class="mb-3">
                    <h5 class="font-semibold text-slate-700 text-sm mb-1">🎁 핵심 혜택</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-slate-600">
                        <li><strong>휴대폰 요금 25% 할인!</strong></li>
                        <li>선택약정 25% + 결합 25% = <strong class="text-green-600">최대 50% 할인!</strong></li>
                        <li>인터넷만 단독으로 쓰면 <strong class="text-green-600">5,500원</strong> 추가 할인!</li>
                    </ul>
                </div>
                <div class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded">
                    <h5 class="font-bold text-amber-800 text-sm mb-1">⚠️ 꼭 확인하세요!</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-amber-700">
                        <li><strong>500M 이상 인터넷</strong>만 가입 가능해요. (100M 불가)</li>
                        <li>본인 휴대폰 1회선이 <strong>7.7만 원 이상</strong> 요금제여야 해요.</li>
                    </ul>
                </div>
            `;
        }
          
        function updateFamilyBundleDetails() {
            familyBundleDetailsContainerEl.innerHTML = `
                 <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-cyan-800 text-base">🏠 패밀리 결합</h4>
                    <button onclick="copyDiscountDetailsToClipboard('familyBundle')" class="btn-secondary text-xs py-1 px-2 rounded-md">내용 복사</button>
                </div>
                <p class="text-sm text-cyan-700 bg-cyan-100 p-2 rounded-md mb-3">
                    "기존에 KT 인터넷을 쓰는 가족이 있을 때, 추가 회선을 저렴하게!"
                </p>
                <div class="mb-3">
                    <h5 class="font-semibold text-slate-700 text-sm mb-1">🎁 핵심 혜택 (추가 회선 기준)</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-slate-600">
                        <li><strong>100M 인터넷:</strong> <strong class="text-green-600">5,500원</strong> 할인</li>
                        <li><strong>500M/1G 인터넷:</strong> <strong class="text-green-600">11,000원</strong> 할인</li>
                    </ul>
                </div>
                <div class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded">
                    <h5 class="font-bold text-amber-800 text-sm mb-1">⚠️ 꼭 확인하세요!</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-amber-700">
                        <li>가족 중 기존 KT 인터넷 사용자(모회선)가 꼭 있어야 해요.</li>
                        <li>설치 후 <strong>1개월 안에</strong> 결합 신청을 해야 해요.</li>
                        <li>법인 명의는 가입할 수 없어요.</li>
                    </ul>
                </div>
            `;
        }
          
        function updateSeparateFamilyDetails() {
            separateFamilyDetailsContainerEl.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-emerald-800 text-base">👨‍👩‍👧‍👦 따로 살아도 가족결합</h4>
                        <button onclick="copyDiscountDetailsToClipboard('separateFamilyBundle')" class="btn-secondary text-xs py-1 px-2 rounded-md">내용 복사</button>
                </div>
                <p class="text-sm text-emerald-700 bg-emerald-100 p-2 rounded-md mb-3">
                    "멀리 살아도 KT 쓰는 가족이 있다면! 총액결합에 할인을 더 받는 신상 결합!"
                </p>
                <div class="mb-3">
                    <h5 class="font-semibold text-slate-700 text-sm mb-1">🎁 핵심 혜택</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-slate-600">
                        <li><strong>500M 인터넷/TV:</strong> 각각 <strong class="text-green-600">2,200원</strong> 추가 할인</li>
                        <li><strong>1G 인터넷/TV:</strong> 각각 <strong class="text-green-600">3,300원</strong> 추가 할인</li>
                        <li>기존 '총액 결합할인'에 <strong class="text-green-600">중복으로 적용</strong>돼요!</li>
                    </ul>
                </div>
                <div class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded">
                    <h5 class="font-bold text-amber-800 text-sm mb-1">⚠️ 꼭 확인하세요!</h5>
                    <ul class="list-disc list-inside text-sm space-y-1 text-amber-700">
                        <li><strong>100M 인터넷은 할인 혜택이 없어요.</strong></li>
                        <li>기존 '뭉치면올레' 결합 사용자는 베이스 회선으로 지정할 수 없어요.</li>
                        <li>'패밀리 결합'의 자회선은 중복 적용이 안돼요.</li>
                        <li>개통 후 다음 달 말까지 꼭 결합 신청을 완료해야 해요.</li>
                    </ul>
                </div>
            `;
        }
          
        function updateMvnoDetails() {
            mvnoDetailsContainerEl.innerHTML = `
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-bold text-gray-800 text-base">📱 KT 알뜰폰 결합</h4>
                <button onclick="copyDiscountDetailsToClipboard('mvnoBundle')" class="btn-secondary text-xs py-1 px-2 rounded-md">내용 복사</button>
            </div>
            <p class="text-sm text-gray-700 bg-gray-100 p-2 rounded-md mb-3">
                "KT망 알뜰폰 유저를 위한 인터넷 요금 할인!"
            </p>
            <div class="mb-3">
                <h5 class="font-semibold text-slate-700 text-sm mb-1">🎁 핵심 혜택 (인터넷 요금만 할인)</h5>
                <ul class="list-disc list-inside text-sm space-y-1 text-slate-600">
                    <li><strong>100M:</strong> <strong class="text-green-600">3,300원</strong> 할인</li>
                    <li><strong>500M/1G (단독):</strong> <strong class="text-green-600">11,000원</strong> 할인</li>
                    <li><strong>500M/1G (TV결합):</strong> <strong class="text-green-600">5,500원</strong> 할인</li>
                </ul>
            </div>
            <div class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded">
                <h5 class="font-bold text-amber-800 text-sm mb-1">⚠️ 꼭 확인하세요!</h5>
                <ul class="list-disc list-inside text-sm space-y-1 text-amber-700">
                    <li>사업자 명의는 가입할 수 없어요.</li>
                    <li>인터넷 설치 후, <strong class="text-amber-900">알뜰폰 고객센터로 직접</strong> 결합을 요청해야 해요.</li>
                    <li>온라인으로 개통한 알뜰폰만 가능해요! (우체국/대리점 개통 불가)</li>
                    <li>결합 가능한 알뜰폰 통신사인지 꼭 확인해야 해요.</li>
                    <li class="mt-1 text-xs break-keep">
                        <strong>결합 가능 통신사:</strong> 1. 엠모바일 2. 미니게이트(쉐이크모바일) 3. 유니컴즈(모빙) 4. 토스모바일 5. 국민은행(리브모바일) 6. 더피엔엘 (퍼스트모바일) 7. 에르엘 (오파스넷모바일) 8. 고고팩토리 9. 스마텔 10. 코드모바일 11. 프리티 12. 니오라코리아 13. 스피츠모바일 14.아이즈비전 15. 스카이라이프( CU관련과 밀리의서재 요금제는 결합이 불가)
                    </li>
                    </ul>
            </div>
        `;
    }
          
        function calculateInstallationFee(internetSelected, tvSelected, phonePlanName, additionalTvSelected, installTime) {
            const timeKey = installTime === 'weekday' ? 'weekday' : 'weekend_night';
            const feeTable = ktInstallationFees_new[timeKey];

            if (!feeTable) {
                return { fee: 0, desc: "설치 시간대를 선택해주세요." };
            }

            // Handle cases without internet upfront for cleaner logic
            if (!internetSelected) {
                if (tvSelected) return { fee: 0, desc: "TV 단독 (비용 별도 문의)" };
                if (phonePlanName !== 'none') return { fee: 0, desc: "전화 단독 (비용 별도 문의)" };
                return { fee: 0, desc: "산정 불가" };
            }

            const phoneSelected = phonePlanName !== 'none';
            const isVoip = phoneSelected && phonePlanName.includes("인터넷전화");
            const isLandline = phoneSelected && !isVoip;
      
            let combinationKey;
            if (tvSelected) {
                if (additionalTvSelected) {
                    combinationKey = "internet_tv_additional_tv";
                } else if (isLandline) {
                    combinationKey = "internet_tv_landline";
                } else if (isVoip) {
                    combinationKey = "internet_tv_voip";
                } else {
                    combinationKey = "internet_tv";
                }
            } else { // No TV
                if (isLandline) {
                    combinationKey = "internet_landline";
                } else if (isVoip) {
                    combinationKey = "internet_voip";
                } else {
                    combinationKey = "internet_only";
                }
            }
      
            const feeInfo = feeTable[combinationKey];
            if (feeInfo) {
                return { fee: feeInfo.cost, desc: feeInfo.description };
            }

            // Fallback for any other unhandled combination
            return { fee: 0, desc: "설치비 산정 불가 (조합 확인 필요)" };
        }
          
          
        function calculateAndDisplayResults() {
            try {
                const results = getCalculationResults();
                displayResults(results);
                generateAllScripts(results);
            } catch (error) {
                console.error("계산 중 오류 발생:", error);
            }
        }
          
        function getCalculationResults(options = {}) {
            const { forcedInternetPlanName = null, forcedDiscountType = null } = options;
      
            // --- 1. Gather Inputs ---
            const internetPlanName = forcedInternetPlanName || internetPlanEl.value;
            const selectedWifiOptionEl = wifiRouterRentalEl.options[wifiRouterRentalEl.selectedIndex];
            const selectedWifiName = selectedWifiOptionEl ? selectedWifiOptionEl.dataset.name : "KT공유기 X";
            const tvPlanName = tvPlanEl.value;
            const additionalTvPlanKey = additionalTvPlanEl.value;
            const phonePlanName = phonePlanEl.value;
            const discountType = forcedDiscountType || document.querySelector('input[name="discountType"]:checked').value;
            const installationTime = document.querySelector('input[name="installationTime"]:checked').value;
            const selectedAddonCheckboxes = document.querySelectorAll('#addonServicesContainer input[type="checkbox"]:checked');
            const isDongpanChecked = dongpanSalesCheckKtEl ? dongpanSalesCheckKtEl.checked : false;
            const installationFeeSelfPay = document.getElementById('installationFeeSelfPay').checked;
      
            const selectedCardId = affiliateCardEl.value;
            const selectedCardTierEl = document.querySelector('input[name="cardTier"]:checked');
            // (Request 4: Card discount applies to the final VAT-included bill, so we keep it as is)
            const cardDiscountAmount = selectedCardTierEl ? parseInt(selectedCardTierEl.value) : 0;
            const selectedCardData = affiliateCardDiscounts[selectedCardId];
      
            let totalMobileBaseCost = 0;
            let mobileLinesData = [];
            document.querySelectorAll('.mobile-line-item').forEach((item, i) => {
                const select = item.querySelector(`#mobilePlan${i}`);
                const checkbox = item.querySelector(`#selectiveContract${i}`);
                const option = select.options[select.selectedIndex];
                const cost = parseInt(option.value) || 0;
                mobileLinesData.push({
                    cost: cost,
                    name: option.dataset.name,
                    url: option.dataset.url,
                    applySelectiveContract: checkbox.checked
                });
                totalMobileBaseCost += cost;
            });
            const numMobileLines = mobileLinesData.length;
      
            // --- 2. Calculate Base Costs (Pre-VAT) ---
            // (Request 4: All costs here are now Pre-VAT)
            let tvBase = (tvPlanName !== 'none' && tvPlans_KT[tvPlanName]) ? tvPlans_KT[tvPlanName].basePrice : 0;
            let additionalTvCost = (additionalTvPlanKey !== 'none' && additionalTvPlans_KT[additionalTvPlanKey]) ? additionalTvPlans_KT[additionalTvPlanKey].basePrice : 0;
            let phoneBase = (phonePlanName !== 'none' && phonePlans_KT[phonePlanName]) ? phonePlans_KT[phonePlanName].basePrice : 0;
            let currentInternet = getSelectedInternetInfo(internetPlanName);
            let internetBase = internetPlanName !== 'none' ? (parseFloat(currentInternet.basePrice) || 0) : 0;
             
            const selectedWifiData = wifiOptions_KT[selectedWifiName];
            let actualWifiRouterFee = selectedWifiData ? selectedWifiData.fee : 0;
            if (currentInternet.speed >= 1000 && selectedWifiName === "KT공유기") {
                actualWifiRouterFee = 0;
            }
             
            let addonServicesTotalCost = 0;
            selectedAddonCheckboxes.forEach(checkbox => {
                addonServicesTotalCost += (parseFloat(checkbox.dataset.price) || 0);
            });
      
            // --- 3. Calculate Discounts (Pre-VAT for Internet/TV, VAT included for Mobile) ---
            let internetDiscount = 0; // Pre-VAT
            let currentTvDiscount = 0; // Pre-VAT
            let totalMobileDiscount = 0; // VAT Included (applies to mobile bill)
            let mobileDiscountDescription = '결합에 따른 모바일 할인 없음.';
            let mobileLinesDetailsForScript = [];
      
            const isTvOrPhoneBundled = tvPlanName !== 'none' || phonePlanName !== 'none';
             
            if (discountType !== 'none' && internetPlanName !== 'none') {
                const internetSpeedType = currentInternet.type;
                const bundleTypeForDiscountRule = isTvOrPhoneBundled ? "TV" : "단독";
      
                // Calculate Internet/TV discounts based on Pre-VAT rules
                if (discountType === 'totalAmountBundle') {
                    let costForDiscountCalc = totalMobileBaseCost;
                    if (totalMobileBaseCost === 0 && numMobileLines > 0) {
                        costForDiscountCalc = 37000;
                    }
                    let mobileTierKey = getMobileTierKey(costForDiscountCalc, numMobileLines, internetSpeedType);
                      
                    if (mobileTierKey && newKtDiscountRules.총액결합할인?.[internetSpeedType]?.[bundleTypeForDiscountRule]?.[mobileTierKey]) {
                        internetDiscount = newKtDiscountRules.총액결합할인[internetSpeedType][bundleTypeForDiscountRule][mobileTierKey];
                    } else if (internetSpeedType === "1G" && bundleTypeForDiscountRule === "TV" && newKtDiscountRules.총액결합할인?.["1G"]?.TV?.["모바일_결합시"] && numMobileLines > 0) {
                        internetDiscount = newKtDiscountRules.총액결합할인["1G"]["TV"]["모바일_결합시"];
                    }
                } else if (discountType === 'fixedRateBundle') {
                    const isStandalone = !isTvOrPhoneBundled;
                    const internetSpeed = currentInternet.speed;
                    // (Request 4: 5500 -> 5000)
                    internetDiscount = 5000; // Base discount
                    if (isStandalone && internetSpeed >= 500) {
                        internetDiscount += 5000; // Add TM 결합 할인 for standalone 500M+
                    }
                } else if (discountType === 'premiumFamilyBundle') {
                    const firstLineCost = numMobileLines > 0 ? mobileLinesData[0].cost : 0;
                    if (numMobileLines > 0 && firstLineCost >= 77000 && currentInternet.speed >= 500) {
                        const fullKey = (currentInternet.speed >= 1000 ? "1G" : "500M") + (isTvOrPhoneBundled ? "_TV" : "_단독");
                        internetDiscount = newKtDiscountRules.프리미엄가족결합?.[fullKey] || 0;
                    }
                } else if (discountType === 'premiumSingleBundle') {
                    const singleLineCost = numMobileLines === 1 ? mobileLinesData[0].cost : 0;
                    if (singleLineCost >= 77000 && currentInternet.speed >= 500 && !isTvOrPhoneBundled) {
                        const speedKey = (currentInternet.speed === 500 ? "500M" : "1G") + "_단독";
                        internetDiscount = newKtDiscountRules.프리미엄싱글결합?.[speedKey] || 0;
                    }
                } else if (discountType === 'mvnoBundle' || discountType === 'familyBundle') {
                    const fullKey = internetSpeedType + "_" + bundleTypeForDiscountRule;
                    const rule = discountType === 'mvnoBundle' ? newKtDiscountRules.알뜰폰결합 : newKtDiscountRules.패밀리결합;
                    internetDiscount = rule?.[fullKey] || 0;
                } else if (discountType === 'separateFamilyBundle') {
                    if (currentInternet.speed >= 500 && totalMobileBaseCost >= 37000) {
                        let mobileTierKey = getMobileTierKey(totalMobileBaseCost, numMobileLines, internetSpeedType);
                        if (mobileTierKey) {
                            if (newKtDiscountRules.총액결합할인?.[internetSpeedType]?.[bundleTypeForDiscountRule]?.[mobileTierKey]) {
                                internetDiscount = newKtDiscountRules.총액결합할인[internetSpeedType][bundleTypeForDiscountRule][mobileTierKey];
                            } else if (internetSpeedType === "1G" && bundleTypeForDiscountRule === "TV" && newKtDiscountRules.총액결합할인?.["1G"]?.TV?.["모바일_결합시"] && numMobileLines > 0) {
                                internetDiscount = newKtDiscountRules.총액결합할인["1G"]["TV"]["모바일_결합시"];
                            }
                        }
                        // (Request 4: 2200->2000, 3300->3000)
                        if (currentInternet.speed === 500) {
                            internetDiscount += 2000;
                            if (isTvOrPhoneBundled) {
                                currentTvDiscount = 2000;
                            }
                        } else if (currentInternet.speed >= 1000) {
                            internetDiscount += 3000;
                            if (isTvOrPhoneBundled) {
                                currentTvDiscount = 3000;
                            }
                        }
                    }
                }
            }
            internetDiscount = Math.min(internetDiscount, internetBase);
      
            // --- START: Mobile Discount Calculation (VAT Included) ---
            let totalAmountBundleMobileDiscount = 0;
            if (discountType === 'totalAmountBundle' && numMobileLines > 0) {
                const internetSpeedKeyForJson = (currentInternet.speed >= 500) ? "500M_1G" : "100M";
                let mobileTierKeyForJson = null;
                if (totalMobileBaseCost < 22000) { mobileTierKeyForJson = "tier1_under_22000"; }
                else if (totalMobileBaseCost < 64900) { mobileTierKeyForJson = "tier2_22000_to_64899"; }
                else if (totalMobileBaseCost < 108900) { mobileTierKeyForJson = "tier3_64900_to_108899"; }
                else if (totalMobileBaseCost < 141900) { mobileTierKeyForJson = "tier4_108900_to_141899"; }
                else if (totalMobileBaseCost < 174900) { mobileTierKeyForJson = "tier5_141900_to_174899"; }
                else { mobileTierKeyForJson = "tier6_over_174900"; }
                const discountInfo = kt_total_mobile_fee_discounts[internetSpeedKeyForJson]?.[mobileTierKeyForJson];
                if (discountInfo) {
                    totalAmountBundleMobileDiscount = discountInfo.mobile_discount || 0;
                }
            }
      
            const totalAmountDiscountsByLine = new Array(numMobileLines).fill(0);
            if (discountType === 'totalAmountBundle' && totalAmountBundleMobileDiscount > 0 && totalMobileBaseCost > 0) {
                let distributedDiscountSum = 0;
                for (let i = 0; i < numMobileLines - 1; i++) {
                    const line = mobileLinesData[i];
                    const proportionalDiscount = Math.round(totalAmountBundleMobileDiscount * (line.cost / totalMobileBaseCost));
                    totalAmountDiscountsByLine[i] = proportionalDiscount;
                    distributedDiscountSum += proportionalDiscount;
                }
                if (numMobileLines > 0) {
                    totalAmountDiscountsByLine[numMobileLines - 1] = totalAmountBundleMobileDiscount - distributedDiscountSum;
                }
            }
             
            let fixedRateMobileTotalDiscount = 0;
            if (discountType === 'fixedRateBundle') {
                if (totalMobileBaseCost >= 77000) fixedRateMobileTotalDiscount = 7000;
                else if (totalMobileBaseCost >= 61000) fixedRateMobileTotalDiscount = 5000;
                else if (totalMobileBaseCost >= 37000) fixedRateMobileTotalDiscount = 3000;
            }
      
            const fixedRateDiscountsByLine = new Array(numMobileLines).fill(0);
            if (fixedRateMobileTotalDiscount > 0 && totalMobileBaseCost > 0) {
                let distributedDiscountSum = 0;
                for (let i = 0; i < numMobileLines - 1; i++) {
                    const line = mobileLinesData[i];
                    const proportionalDiscount = Math.round(fixedRateMobileTotalDiscount * (line.cost / totalMobileBaseCost));
                    fixedRateDiscountsByLine[i] = proportionalDiscount;
                    distributedDiscountSum += proportionalDiscount;
                }
                if (numMobileLines > 0) {
                    fixedRateDiscountsByLine[numMobileLines - 1] = fixedRateMobileTotalDiscount - distributedDiscountSum;
                }
            }
      
            let premiumFamilyProportionalDiscounts = new Map();
            if (discountType === 'premiumFamilyBundle' && numMobileLines > 0) {
                const linesUnder77k = mobileLinesData
                    .map((line, index) => ({ ...line, originalIndex: index }))
                    .filter((line, index) => index > 0 && line.cost > 0 && line.cost < 77000);
      
                if (linesUnder77k.length > 0 && mobileLinesData[0].cost > 0) {
                    const participatingLines = [{ ...mobileLinesData[0], originalIndex: 0 }, ...linesUnder77k];
                    const totalCostForSpecialCalc = participatingLines.reduce((sum, line) => sum + line.cost, 0);
                      
                    const internetSpeedKeyForJson = (currentInternet.speed >= 500) ? "500M_1G" : "100M";
                    let mobileTierKeyForJson = null;
                    if (totalCostForSpecialCalc < 22000) { mobileTierKeyForJson = "tier1_under_22000"; } 
                    else if (totalCostForSpecialCalc < 64900) { mobileTierKeyForJson = "tier2_22000_to_64899"; } 
                    else if (totalCostForSpecialCalc < 108900) { mobileTierKeyForJson = "tier3_64900_to_108899"; } 
                    else if (totalCostForSpecialCalc < 141900) { mobileTierKeyForJson = "tier4_108900_to_141899"; } 
                    else if (totalCostForSpecialCalc < 174900) { mobileTierKeyForJson = "tier5_141900_to_174899"; } 
                    else { mobileTierKeyForJson = "tier6_over_174900"; }
      
                    const discountInfo = kt_total_mobile_fee_discounts[internetSpeedKeyForJson]?.[mobileTierKeyForJson];
                    const totalMobileDiscountForGroup = discountInfo?.mobile_discount || 0;
      
                    if (totalMobileDiscountForGroup > 0) {
                        let distributedSum = 0;
                        participatingLines.filter(p => p.originalIndex !== 0).forEach(pLine => {
                            const discount = Math.round(totalMobileDiscountForGroup * (pLine.cost / totalCostForSpecialCalc));
                            premiumFamilyProportionalDiscounts.set(pLine.originalIndex, discount);
                            distributedSum += discount;
                        });
                        premiumFamilyProportionalDiscounts.set(0, totalMobileDiscountForGroup - distributedSum);
                    }
                }
            }
      
            mobileLinesDetailsForScript = mobileLinesData.map((line, i) => {
                if (line.cost === 0) {
                    return { ...line, selectiveDiscount: 0, bundleDiscount: 0, totalAmountLineDiscount: 0, fixedRateLineDiscount: 0, finalBill: 0 };
                }
                let selectiveDiscount = line.applySelectiveContract ? Math.floor(line.cost * 0.25) : 0;
                let bundleDiscount = 0;
                let totalAmountLineDiscount = 0;
                let fixedRateLineDiscount = 0;
      
                if (discountType === 'totalAmountBundle') {
                    totalAmountLineDiscount = totalAmountDiscountsByLine[i];
                } else if (discountType === 'fixedRateBundle') {
                    fixedRateLineDiscount = fixedRateDiscountsByLine[i] || 0;
                } else if (discountType === 'premiumFamilyBundle') {
                    if (premiumFamilyProportionalDiscounts.has(i)) {
                        bundleDiscount = premiumFamilyProportionalDiscounts.get(i);
                    } else {
                        if (i === 0 && line.cost >= 77000) {
                            bundleDiscount = 5500;
                        } else if (i >= 1 && line.cost >= 77000) {
                            bundleDiscount = Math.floor(line.cost * 0.25);
                        }
                    }
                } else if (discountType === 'premiumSingleBundle') {
                    if (i === 0 && line.cost >= 77000) {
                        bundleDiscount = Math.floor(line.cost * 0.25);
                    }
                }
      
                const totalLineDiscount = selectiveDiscount + bundleDiscount + totalAmountLineDiscount + fixedRateLineDiscount;
                const finalBill = line.cost - totalLineDiscount;
                totalMobileDiscount += totalLineDiscount;
                return { ...line, selectiveDiscount, bundleDiscount, totalAmountLineDiscount, fixedRateLineDiscount, finalBill };
            });
             
      
            // --- 4. Calculate Final Costs (Pre-VAT and VAT Included) and Gifts ---
            // (Request 4: Calculate Pre-VAT costs first)
            const totalPreDiscountCost_PreVat = internetBase + actualWifiRouterFee + tvBase + additionalTvCost + phoneBase + addonServicesTotalCost;
            const finalMonthlyCost_PreVat = (internetBase - internetDiscount) + actualWifiRouterFee + (tvBase - currentTvDiscount) + additionalTvCost + phoneBase + addonServicesTotalCost;
             
            // Calculate VAT
            const vatAmount = Math.round(finalMonthlyCost_PreVat * 0.1);
             
            // Calculate VAT Included costs
            const totalPreDiscountCost = Math.round(totalPreDiscountCost_PreVat * 1.1);
            const finalMonthlyCost = finalMonthlyCost_PreVat + vatAmount;
             
            // Apply card discount to the final VAT-included cost
            const finalCostWithCard = finalMonthlyCost - cardDiscountAmount;
      
            let giftCash = 0, giftVoucher = 0, giftPhoneVoucherAmount = 0, giftAdditionalTvAmount = 0, giftDongpanAdditionalCashAmount = 0;
            const reviewEventGift = 0;
            const referralEventGift = 0;
      
            if (internetPlanName !== 'none') {
                const internetSpeed = currentInternet.speed;
                const isTvSelectedForGift = tvPlanName !== 'none';
                const tvOptionForGift = Array.from(tvPlanEl.options).find(opt => opt.value === tvPlanName);
                const tvCategoryForGift = isTvSelectedForGift && tvOptionForGift ? (tvOptionForGift.dataset.category || "베이직") : "베이직";

                if (currentInternet.isOttPlan) {
                    const rules = isTvSelectedForGift ? ottCommissionRules_KT.internet_tv.commission_rules : ottCommissionRules_KT.internet_only.commission_rules;
                    // For simplicity, we'll just take the first matching rule's max support money.
                    // A more complex implementation could allow selecting a commission tier.
                    const applicableRule = rules[0];
                    if(isTvSelectedForGift) {
                        giftCash = applicableRule.support_money_max;
                        giftVoucher = 0;
                    } else {
                        // For internet only, the structure is different
                        giftCash = applicableRule.support_money; // Example, might need adjustment based on payout_method
                        giftVoucher = 0; // Or parse from payout_method
                    }

                } else {
                    let giftKeyPrefix = "";
                    if (!isTvSelectedForGift) {
                        if (internetSpeed === 100) giftKeyPrefix = "100단독";
                        else if (internetSpeed === 500) giftKeyPrefix = "500단독";
                        else if (internetSpeed >= 1000) giftKeyPrefix = "1G단독";
                    } else {
                        if (internetSpeed === 100) giftKeyPrefix = "100번들";
                        else if (internetSpeed === 500) giftKeyPrefix = "500번들";
                        else if (internetSpeed >= 1000) giftKeyPrefix = "기가번들";
                    }
                    if (giftTable[tvCategoryForGift] && giftTable[tvCategoryForGift][giftKeyPrefix]) {
                        giftCash = giftTable[tvCategoryForGift][giftKeyPrefix].cash;
                        giftVoucher = giftTable[tvCategoryForGift][giftKeyPrefix].voucher;
                    }
                }

                if (isDongpanChecked && numMobileLines > 0) {
                    const isFamilyBundle = discountType === 'familyBundle';
                    const ownerType = isFamilyBundle ? "패밀리" : "일반";
                    let productKey = "";
                    if (!isTvSelectedForGift) {
                        if (internetSpeed === 100) productKey = "100Mb 단독";
                        else if (internetSpeed === 500) productKey = "500Mb 단독";
                        else if (internetSpeed >= 1000) productKey = "1Gb 단독";
                    } else {
                        if (internetSpeed === 100) productKey = "100Mb+TV";
                        else if (internetSpeed === 500) productKey = "500Mb+TV";
                        else if (internetSpeed >= 1000) productKey = "1Gb+TV";
                    }
      
                    const maxDongpanLines = isTvSelectedForGift ? 3 : 1;
                    for (let i = 0; i < Math.min(numMobileLines, maxDongpanLines); i++) {
                        const mobileLineFee = mobileLinesData[i].cost;
                        let mobileFeeTierKey = null;
                        if (mobileLineFee >= 37000 && mobileLineFee < 61000) mobileFeeTierKey = "37K 요금제";
                        else if (mobileLineFee >= 61000 && mobileLineFee < 90000) mobileFeeTierKey = "61K 요금제";
                        else if (mobileLineFee >= 90000) mobileFeeTierKey = "90K 요금제";
                         
                        if (mobileFeeTierKey && productKey) {
                            const lookupKey = `${productKey} ${ownerType}`;
                            const rule = dongpanGiftRules_New[mobileFeeTierKey]?.[lookupKey];
                            if (rule) {
                                if (i === 0) { // First line
                                    const mainGift = parseInt(rule["인터넷 명의자 사은품"]?.["유심"] || 0);
                                    giftDongpanAdditionalCashAmount += mainGift;
                                } else { // Second and third lines
                                    const familyGiftRaw = rule["가족 사은품"];
                                    const familyGift = (typeof familyGiftRaw === 'number') ? familyGiftRaw : 0;
                                    giftDongpanAdditionalCashAmount += familyGift;
                                }
                            }
                        }
                    }
                }
            }
            if (phonePlanName !== 'none') giftPhoneVoucherAmount = 20000;
            if (additionalTvPlanKey !== 'none') giftAdditionalTvAmount = 30000;
             
            const confirmedGiftAmount = giftCash + giftVoucher + giftPhoneVoucherAmount + giftAdditionalTvAmount + giftDongpanAdditionalCashAmount;
            const maxGiftAmount = confirmedGiftAmount;
      
            // --- 5. Installation Fee (VAT Included) ---
            const installInfo = calculateInstallationFee(internetPlanName !== 'none', tvPlanName !== 'none', phonePlanName, additionalTvPlanKey !== 'none', installationTime);
      
            // --- 6. Return all results ---
            return {
                // Inputs
                internetPlanName, tvPlanName, additionalTvPlanKey, phonePlanName,
                selectedWifiName, selectedWifiData, discountType, numMobileLines, isDongpanChecked, installationTime,
                isPostApplied: ['totalAmountBundle', 'mvnoBundle', 'premiumFamilyBundle', 'premiumSingleBundle', 'fixedRateBundle'].includes(discountType),
                // Costs (VAT Included)
                totalPreDiscountCost, finalMonthlyCost, finalCostWithCard,
                // Costs (Pre-VAT)
                finalMonthlyCost_PreVat, vatAmount,
                internetBase, tvBase, additionalTvCost, phoneBase, addonServicesTotalCost, actualWifiRouterFee,
                // Discounts (Internet/TV Pre-VAT, Mobile VAT Included)
                internetDiscount, currentTvDiscount, totalMobileDiscount, cardDiscountAmount, selectedCardData,
                // Mobile Details
                mobileLinesDetails: mobileLinesDetailsForScript,
                mobileDiscountDescription,
                // Gifts
                giftCash, giftVoucher, giftPhoneVoucherAmount, giftAdditionalTvAmount, giftDongpanAdditionalCashAmount,
                confirmedGiftAmount, maxGiftAmount,
                // Installation
                installFee: installInfo.fee,
                installFeeDesc: installInfo.desc,
                // Other info
                currentInternet,
                installationFeeSelfPay,
            };
        }
          
        function displayResults(results) {
            const {
                // VAT Included
                finalMonthlyCost, finalCostWithCard, totalPreDiscountCost, totalMobileDiscount,
                cardDiscountAmount, selectedCardData,
                maxGiftAmount, confirmedGiftAmount,
                installFee, installFeeDesc, installationTime, mobileLinesDetails,
                // Pre-VAT
                finalMonthlyCost_PreVat, vatAmount,
                internetDiscount, currentTvDiscount,
                internetBase, tvBase, additionalTvCost, phoneBase, addonServicesTotalCost, actualWifiRouterFee,
                // Inputs
                internetPlanName, tvPlanName, additionalTvPlanKey, phonePlanName, selectedWifiName, selectedWifiData,
                numMobileLines, discountType, currentInternet
            } = results;
      
            // Summary Card (VAT Included)
            const costToShowInSummary = cardDiscountAmount > 0 ? finalCostWithCard : finalMonthlyCost;
            summaryFinalCostEl.textContent = `${costToShowInSummary.toLocaleString()} 원`;
            if (cardDiscountAmount > 0) {
                summaryCardAppliedEl.textContent = `(${selectedCardData.name} 적용가)`;
            } else {
                summaryCardAppliedEl.textContent = '';
            }
      
            if (totalPreDiscountCost > finalMonthlyCost) {
                summaryPreDiscountCostEl.textContent = `할인 전 ${totalPreDiscountCost.toLocaleString()} 원`;
                summaryPreDiscountCostEl.style.display = 'block';
            } else {
                summaryPreDiscountCostEl.style.display = 'none';
            }
            // (Request 4: Display internet discount VAT included in summary)
            const totalInternetDiscountVatIncluded = Math.round((internetDiscount + currentTvDiscount) * 1.1);
            summaryInternetDiscountEl.textContent = `- ${totalInternetDiscountVatIncluded.toLocaleString()} 원`;
            summaryMobileDiscountEl.textContent = `- ${totalMobileDiscount.toLocaleString()} 원`;
            summaryGiftTotalEl.textContent = `${maxGiftAmount.toLocaleString()} 원`;
            document.getElementById('summaryGiftBreakdown').textContent = `(확정 사은품 ${confirmedGiftAmount.toLocaleString()}원)`;
      
            // Expanded Details (Pre-VAT for details, VAT Included for final totals)
            const internetOption = Array.from(internetPlanEl.options).find(opt => opt.value === internetPlanName);
            selectedInternetEl.textContent = internetOption ? internetOption.text.split(" (")[0] : '미선택';
            const tvOption = Array.from(tvPlanEl.options).find(opt => opt.value === tvPlanName);
            selectedTvEl.textContent = tvOption && tvOption.value !=='none' ? tvOption.text.split(" (")[0] : '미선택';
            selectedAdditionalTvEl.textContent = additionalTvPlanKey !== 'none' ? additionalTvPlans_KT[additionalTvPlanKey].name : '미선택';
            const phoneOption = Array.from(phonePlanEl.options).find(opt => opt.value === phonePlanName);
            selectedPhoneEl.textContent = phoneOption && phoneOption.value !== 'none' ? phoneOption.text.split(" (")[0] : '미선택';
            selectedWifiEl.textContent = selectedWifiName || '미선택';
            selectedMobileCountEl.textContent = numMobileLines;
      
            if (selectedWifiData && selectedWifiData.promotion) {
                selectedWifiDetailsEl.innerHTML = `<p class="text-sm text-sky-700 mt-1">
                    ㄴ 프로모션: ${selectedWifiData.promotion}
                    ${selectedWifiData.url ? `<a href="${selectedWifiData.url}" target="_blank" class="font-semibold underline hover:text-sky-500 ml-2">[제품 상세정보]</a>` : ''}
                </p>`;
            } else {
                selectedWifiDetailsEl.innerHTML = '';
            }
      
            const discountTypeMap = {
                none: "결합 할인 없음", totalAmountBundle: "총액 결합할인", premiumFamilyBundle: "프리미엄 가족결합",
                premiumSingleBundle: "프리미엄 싱글결합", mvnoBundle: "알뜰폰 결합", familyBundle: "패밀리 결합 (인터넷 추가회선)",
                separateFamilyBundle: "따로 살아도 가족결합", 
                fixedRateBundle: "정액 결합할인"
            };
            selectedDiscountTypeEl.textContent = discountTypeMap[discountType] || "알 수 없음";
      
            // (Request 4: Displaying Pre-VAT details)
            detailInternetBaseEl.textContent = `${(internetBase + tvBase + additionalTvCost + phoneBase + addonServicesTotalCost).toLocaleString()} 원`;
            detailWifiFeeEl.textContent = `${actualWifiRouterFee.toLocaleString()} 원`;
            detailInternetDiscountTotalEl.textContent = `- ${(internetDiscount + currentTvDiscount).toLocaleString()} 원`;
            detailFinalCostPreVatEl.textContent = `${finalMonthlyCost_PreVat.toLocaleString()} 원`;
            detailVatAmountEl.textContent = `${vatAmount.toLocaleString()} 원`;
            detailFinalCostEl.textContent = `${finalMonthlyCost.toLocaleString()} 원`;
             
            if (cardDiscountAmount > 0 && selectedCardData) {
                selectedCardNameEl.textContent = selectedCardData.name;
                detailCardDiscountEl.textContent = `- ${cardDiscountAmount.toLocaleString()} 원`;
                detailFinalCardCostEl.textContent = `${finalCostWithCard.toLocaleString()} 원`;
                detailCardDiscountContainerEl.classList.remove('hidden');
                detailFinalCardCostContainerEl.classList.remove('hidden');
                finalCardCostSeparatorEl.classList.remove('hidden');
            } else {
                detailCardDiscountContainerEl.classList.add('hidden');
                detailFinalCardCostContainerEl.classList.add('hidden');
                finalCardCostSeparatorEl.classList.add('hidden');
            }
      
            // Mobile Discount Details (VAT Included)
            let mobileDiscountHtml = '<div class="space-y-3">';
            if (mobileLinesDetails.length > 0 && mobileLinesDetails.some(l => l.cost > 0)) {
                    mobileLinesDetails.forEach(line => {
                        if (line.cost === 0) return;
                        let discountDetailString = '';
                        if (line.totalAmountLineDiscount > 0) discountDetailString += ` - ${line.totalAmountLineDiscount.toLocaleString()}원(총액)`;
                        if (line.fixedRateLineDiscount > 0) discountDetailString += ` - ${line.fixedRateLineDiscount.toLocaleString()}원(정액)`;
                        if (line.bundleDiscount > 0) discountDetailString += ` - ${line.bundleDiscount.toLocaleString()}원(결합)`;
                        if (line.selectiveDiscount > 0) discountDetailString += ` - ${line.selectiveDiscount.toLocaleString()}원(선택약정)`;
                        mobileDiscountHtml += `<div class="p-2 border-t border-slate-200">
                                            <p class="font-semibold">${line.name} (${line.cost.toLocaleString()}원)</p>
                                            <p class="text-sm pl-2"> ㄴ ${line.cost.toLocaleString()}원${discountDetailString} = <strong class="text-blue-600">${line.finalBill.toLocaleString()}원</strong> 
                                            <a href="${line.url}" target="_blank" class="text-blue-500 hover:underline">(상세)</a>
                                            </p></div>`;
                    });
            } else {
                mobileDiscountHtml += `<p>결합에 따른 모바일 할인 없음.</p>`;
            }
            mobileDiscountHtml += '</div>';
            mobileDiscountDetailContainerEl.innerHTML = mobileDiscountHtml;
      
      
            // Gift Details
            giftCashEl.textContent = `${results.giftCash.toLocaleString()} 원`;
            giftVoucherEl.textContent = `${results.giftVoucher.toLocaleString()} 원`;
            giftPhoneVoucherEl.textContent = `${results.giftPhoneVoucherAmount.toLocaleString()} 원`;
            giftAdditionalTvEl.textContent = `${results.giftAdditionalTvAmount.toLocaleString()} 원`;
            dongpanCashContainerKtEl.classList.toggle('hidden', !results.isDongpanChecked || results.giftDongpanAdditionalCashAmount === 0);
            giftDongpanAdditionalCashKtEl.textContent = `${results.giftDongpanAdditionalCashAmount.toLocaleString()} 원`;
            if (giftTotalEl) {
                 giftTotalEl.textContent = `${maxGiftAmount.toLocaleString()} 원`;
            }
      
            // Installation Fee (VAT Included)
            installationFeeResultEl.textContent = `${installFee.toLocaleString()} 원`;
            installationFeeDescriptionEl.textContent = `(${installFeeDesc}, ${installationTime === 'weekday' ? '평일 주간' : '주말/야간'} 기준)`;
      
            // Show sections
            resultSection.classList.remove('hidden');
            installationFeeSectionEl.classList.remove('hidden');
            messageScriptSectionEl.classList.remove('hidden');
            // (Request 2: Removed Gemini card showing logic)
             
            const recommendationBoxEl = document.getElementById('recommendationBox');
            const recommendation = compareAndRecommend(results);
      
            if (recommendation.show) {
                document.getElementById('recommendationTitle').textContent = recommendation.title;
                document.getElementById('recommendationBody').innerHTML = recommendation.body;
                document.getElementById('recommendationAction').innerHTML = recommendation.actionHTML;
                recommendationBoxEl.classList.remove('hidden');
            } else {
                recommendationBoxEl.classList.add('hidden');
            }
        }
          
        function generateAllScripts(results) {
            const {
                isPostApplied, installTime, discountType, isDongpanChecked, numMobileLines,
                totalPreDiscountCost, finalMonthlyCost, installFee,
                mobileLinesDetails, selectedWifiData, confirmedGiftAmount, maxGiftAmount,
                internetPlanName, tvPlanName, additionalTvPlanKey, phonePlanName,
                currentInternet, finalCostWithCard, cardDiscountAmount, selectedCardData,
                finalMonthlyCost_PreVat,
                installationFeeSelfPay
            } = results;
            
            // --- 1. Generate Memo Script (VAT INCLUDED) ---
            const internetOption = Array.from(internetPlanEl.options).find(opt => opt.value === internetPlanName);
            const internetPlanText = internetOption ? internetOption.text.split(' (')[0] : '인터넷 미선택';
            const tvOption = Array.from(tvPlanEl.options).find(opt => opt.value === tvPlanName);
            let firstTvText = "미선택";
                if (tvOption && tvOption.value !== 'none' && tvPlans_KT[tvOption.value]) { 
                        firstTvText = `${tvOption.text.split(' (')[0]} + ${tvPlans_KT[tvOption.value].stbIncluded} 셋톱 임대 포함`;
                    }
            const additionalTvText = additionalTvPlanKey !== 'none' ? ` + (추가) ${additionalTvPlans_KT[additionalTvPlanKey].name}` : "";
            const phoneOption = Array.from(phonePlanEl.options).find(opt => opt.value === phonePlanName);
            let phoneText = "미선택";
            if (phoneOption && phoneOption.value !== 'none' && phonePlans_KT[phoneOption.value]) {
                phoneText = phoneOption.text.split(' (')[0];
            }
            const wifiName = selectedWifiData ? selectedWifiData.name : "미선택";
      
            let productDescriptionMemo = internetPlanText;
            if (wifiName !== "KT공유기 X") productDescriptionMemo += ` + ${wifiName}`;
            if (tvOption && tvOption.value !== 'none') {
                const tvPlanInfo = tvPlans_KT[tvOption.value];
                if (tvPlanInfo) {
                    productDescriptionMemo += ` + ${tvOption.text.split(' (')[0]} + ${tvPlanInfo.stbIncluded}`;
                }
            }
            productDescriptionMemo += additionalTvText;
            if (phoneText !== "미선택") productDescriptionMemo += ` + ${phoneText}`;
             
            const discountTypeName = selectedDiscountTypeEl.textContent;
            const mobilePlanNamesForMemo = mobileLinesDetails.filter(line => line.cost > 0).map(line => line.name).join(', ') || '없음';
      
            // Memo uses VAT INCLUDED costs
            const finalCostForMemo = cardDiscountAmount > 0 ? finalCostWithCard : finalMonthlyCost;
            const cardInfoForMemo = cardDiscountAmount > 0 ? ` / (카드적용가)${finalCostWithCard.toLocaleString()}원` : "";
      
            // (Request 3: Rebranding, Request 6: Added new fields)
            memoScriptEl.value = `[웨이팅 인터넷 통합접수센터 상담 메모]
이름:
핸드폰 번호:
핸드폰 통신사:
주민번호:
설치할 주소:
사은품 받을 계좌번호:
사은품(상/현)/ 자체지급:

1. 상품정보 : ${productDescriptionMemo}
2. 청구 금액 : (할인전)${totalPreDiscountCost.toLocaleString()}원 / (할인후)${finalMonthlyCost.toLocaleString()}원${cardInfoForMemo} (VAT 포함)
3. 제휴카드 반영시: ${cardDiscountAmount > 0 ? '반영됨 (' + selectedCardData.name + ')' : '미반영'}
4. 사은품 총액 : ${maxGiftAmount.toLocaleString()}원 (확정)
5. 설치비 안내완 : ${installFee.toLocaleString()}원 ${installationFeeSelfPay ? '(자체지급)' : ''}
6. 결합적용시점: ${isPostApplied ? '후결합' : '선결합'}
7. 인증연락30분후 가능:
8. 설치일정: [    년  월  일]
9. 기존사용 인터넷 통신사:
10. 기타 : 이사 여부 [ ]
11. 할인유형: ${discountTypeName}
12. 모바일결합회선: ${numMobileLines}개
13. 동판판매가적용: ${isDongpanChecked ? 'Y' : 'N'}
      
    --- 동판 추가 정보 ---
    고객명 :
    동판유선명의자 :
    연락처 :
    기존통신사 :
    유심발송주소 :
    선택약정여부 (12개월/24개월) : 12개월
    요금제 : ${mobilePlanNamesForMemo}
    유심비 후청구 동의 (Y/N) : Y
    ★ 결합여부 (프리미엄가족/프리미엄싱글/총액) : ${discountTypeName}
    ★ 할인지정(지정할인or기여도) : 기여도
    ★ 동판 결합인증 (URL 완료여부) : 완료
    ★ 패스or신용카드 인증 : 패스인증
      
    --- 필수 안내사항 ---
    고객 상황에따른 필수안내사항 완료
    1.  기존 가족 또는 본인 명의 회선 있는 경우 유지 필요 안내 완료
    2.  이사 고객 Y / 추후 소명 발생 시 관련 서류 제출 동의 수긍
    3.  인터넷 설치 후 고객센터로 후결합 요청 안내 완료`;
      
            // --- 2. Generate Info Script (VAT EXCLUDED) ---
            infoScriptEl.value = generateInfoScriptForPlan(results);
      
            // --- 3. Generate Complete Script (VAT EXCLUDED) ---
            let productDescriptionComplete = [];
            if (internetPlanText !== '인터넷 미선택') {
                let internetLine = `▶️ ${internetPlanText}`;
                if (wifiName !== "KT공유기 X" && wifiName !== "미선택") {
                    internetLine += ` + ${wifiName}`;
                }
                productDescriptionComplete.push(internetLine);
            }
            if (firstTvText !== "미선택") {
                productDescriptionComplete.push(`▶️ ${firstTvText}`);
            }
            if (additionalTvText) {
                productDescriptionComplete.push(`▶️ ${additionalTvText.replace(' + ', '')}`);
            }
             if (phoneText !== "미선택") {
                productDescriptionComplete.push(`▶️ ${phoneText}`);
            }
             
            if (currentInternet.isOttPlan) {
                productDescriptionComplete.push(`▶️ 종합OTT6종 3년간 무상지원(넷플릭스/티빙/디즈니플러스/웨이브/쿠팡플레이/지상파다시보기/총70만원상당)`);
            }

            // Complete script uses VAT EXCLUDED costs
            // Calculate Pre-VAT cost after card discount (for perceived lower cost)
            const finalCostPreVat_WithCard = finalMonthlyCost_PreVat - cardDiscountAmount;
            const finalCostForComplete = cardDiscountAmount > 0 ? finalCostPreVat_WithCard : finalMonthlyCost_PreVat;

            const cardInfoForComplete = cardDiscountAmount > 0 ? ` (${selectedCardData.name} 적용가)` : (discountType !== 'none' ? ' (결합 O)' : ' (결합 X)');
      
            let completeScriptContent = `[웨이팅 인터넷 통합접수센터] 가입 완료 안내
    안녕하세요, 고객님.
    인터넷 통합접수센터 입니다.
    ✅ 계약이 완료되었어요, 아래 내용은 계약서와 동일한 효력이 있으니 꼼꼼히 읽어주세요.
    ⚠️ 3년 약정이며, 아래와 같은 상황에 해당하면 받으셨던 사은품은 환수 됩니다.
    ① 1년 이내 해지
    ② 3개월 (90일) 이상 정지
    ③ 1년 이내 요금제 하향 (상향 시에는 환수 되지 않습니다!)
    ④ 3개월 이내 명의변경
    ⑤ 개통 1개월 이내 결제수단 지로청구서로 변경
    ⚠️ 신규 가입 후 기존에 인터넷은 꼭 해지 해주세요. 자동해지되지 않으며 이럴 경우 요금이 이중 부과되어요.
    ⚠️ 3년 이내 해지 시 통신사 본사에 위약금 (할인 반환금) 및 통신사에 따라 면제된 와이파이 / 통신기기 설치비 반환이 필요할 수 있어요.
    ✅ 가입 상품 안내
    ${productDescriptionComplete.join('\n')}
    ▶️ 월 ${finalCostForComplete.toLocaleString()}원${cardInfoForComplete} (⚠️VAT 별도)
    ▶️ 설치비 ${installFee.toLocaleString()}원 첫 달 부과 (VAT 포함) ${installationFeeSelfPay ? '(자체 지원)' : ''}
    ▶️ 사은품 ${confirmedGiftAmount.toLocaleString()}원 (확정)
    
    * 안내된 월 요금은 VAT(부가세) 별도 금액이며, 실제 청구 시 10%의 부가세가 추가됩니다.
    ✅사은품은 설치 후 7일 이내 자동으로 지급되나 평일기준 5시 이전 개통 받았다고 문자 주시면 당일입금 도움드리겠습니다.`;
      
            if (isPostApplied) {
                completeScriptContent += `
      
    ---
    ⚠️ [필독] 월 요금 할인을 위한 마지막 단계!
      
    고객님, 설치 후 30일 이내에 직접 결합 신청을 완료하셔야 매달 요금 할인이 적용됩니다.
    아래 번호로 전화하셔서 "인터넷이랑 휴대폰(또는 TV) 결합 신청합니다"라고 말씀해주세요!
    (기한이 지나 할인을 놓치시는 일이 없도록 지금 바로 신청하시는 것을 권해드립니다.)
      
    ■ KT 고객님: 휴대폰에서 100번으로 전화
    ---`;
            }
      
            completeScriptContent += `
      
    인터넷 통합접수센터 김홍식 드림.`;
      
            completeScriptEl.value = completeScriptContent;
      
            // Generate other static/persuasion scripts
            generatePersuasionScripts(currentInternet);
        }
          
        function generateInfoScriptForPlan(results) {
            const { 
                internetPlanName, tvPlanName, additionalTvPlanKey, phonePlanName,
                selectedWifiData, mobileLinesDetails,
                confirmedGiftAmount, maxGiftAmount,
                cardDiscountAmount, selectedCardData,
                finalMonthlyCost_PreVat,
                currentInternet,
                installationFeeSelfPay,
                installFee
            } = results;
      
            const discountTypeName = selectedDiscountTypeEl.textContent;
      
            const internetOption = Array.from(internetPlanEl.options).find(opt => opt.value === internetPlanName);
            const internetPlanText = internetOption ? internetOption.text.split(' (')[0] : '인터넷 미선택';
             
            const tvOption = Array.from(tvPlanEl.options).find(opt => opt.value === tvPlanName);
            let firstTvText = "미선택";
            if (tvOption && tvOption.value !== 'none' && tvPlans_KT[tvOption.value]) { 
                firstTvText = `${tvOption.text.split(' (')[0]} + ${tvPlans_KT[tvOption.value].stbIncluded} 셋톱 임대 포함`;
            }
            const additionalTvText = additionalTvPlanKey !== 'none' ? ` + (추가) ${additionalTvPlans_KT[additionalTvPlanKey].name}` : "";
             
            const phoneOption = Array.from(phonePlanEl.options).find(opt => opt.value === phonePlanName);
            let phoneText = "미선택";
            if (phoneOption && phoneOption.value !== 'none') {
                phoneText = phoneOption.text.split(' (')[0];
            }
      
            let productDescriptionInfo = `[유선 상품]
    ▶️ ${internetPlanText}
    ▶️ ${firstTvText !== '미선택' ? firstTvText : 'TV 미선택'}${additionalTvText}
    ▶️ ${phoneText !== '미선택' ? phoneText : '집전화 미선택'}`;
             
            if (selectedWifiData && selectedWifiData.name !== "KT공유기 X") {
                productDescriptionInfo += `\n▶️ ${selectedWifiData.name}`;
                if (selectedWifiData.url) {
                    productDescriptionInfo += `\n    (정보: ${selectedWifiData.url})`;
                }
            }

            if (currentInternet.isOttPlan) {
                productDescriptionInfo += `\n▶️ 종합OTT6종 3년간 무상지원(넷플릭스/티빙/디즈니플러스/웨이브/쿠팡플레이/지상파다시보기/총70만원상당)`;
            }
             
            const actualMobileLines = mobileLinesDetails.filter(line => line.cost > 0);
            if (actualMobileLines.length > 0) {
                productDescriptionInfo += `\n\n[결합 모바일]`;
                actualMobileLines.forEach(line => {
                    let discountText = '';
                    if (line.totalAmountLineDiscount > 0) discountText += ` - ${line.totalAmountLineDiscount.toLocaleString()} (총액)`;
                    if (line.fixedRateLineDiscount > 0) discountText += ` - ${line.fixedRateLineDiscount.toLocaleString()} (정액)`;
                    if (line.bundleDiscount > 0) discountText += ` - ${line.bundleDiscount.toLocaleString()} (결합)`;
                    if (line.selectiveDiscount > 0) discountText += ` - ${line.selectiveDiscount.toLocaleString()} (선약)`;
                      
                    productDescriptionInfo += `\n▶️ ${line.name} (${line.cost.toLocaleString()}원)${discountText} = 최종 ${line.finalBill.toLocaleString()}원`;
                    if (line.url) {
                        productDescriptionInfo += `\n    (정보: ${line.url})`;
                    }
                });
            }

            // Calculate Pre-VAT cost after card discount (for perceived lower cost)
            const finalCostPreVat_WithCard = finalMonthlyCost_PreVat - cardDiscountAmount;

            let finalCostBlock = `[최종 요금 및 혜택]
    ▶️ 월 ${finalMonthlyCost_PreVat.toLocaleString()}원 (${discountTypeName}, <span style="font-size: 0.8em;">VAT별도</span>)
    ▶️ 사은품 ${confirmedGiftAmount.toLocaleString()}원 (확정)`;

            if (installationFeeSelfPay) {
                finalCostBlock += `\n    ▶️ 설치비 ${installFee.toLocaleString()}원 지원 (자체지급)`;
            }
             
            if (cardDiscountAmount > 0 && selectedCardData) {
                const selectedCardTierEl = document.querySelector('input[name="cardTier"]:checked');
                // Ensure tierLabel is derived correctly even if the DOM structure changes slightly
                let tierLabel = "실적 충족";
                if (selectedCardTierEl && selectedCardTierEl.parentElement) {
                    const fullLabelText = selectedCardTierEl.parentElement.textContent.trim();
                    tierLabel = fullLabelText.split(' (')[0];
                }

                finalCostBlock += `
      
    [💳 ${selectedCardData.name} 추가 할인으로 더 저렴하게!]
    고객님, ${selectedCardData.name}으로 결제하고 전월 ${tierLabel} 사용 시, 매달 ${cardDiscountAmount.toLocaleString()}원을 추가로 아끼실 수 있습니다!
      
    기존 월 ${finalMonthlyCost_PreVat.toLocaleString()}원 - 카드 자동이체 청구 할인 ${cardDiscountAmount.toLocaleString()}원
    = ✨ 최종 월 납부액 ${finalCostPreVat_WithCard.toLocaleString()}원! ✨ (<span style="font-size: 0.8em;">VAT별도</span>)
      
    * 본 할인은 전월 실적 충족 시 적용되며, 자세한 내용은 ${selectedCardData.name}(${selectedCardData.phone})로 문의 바랍니다.`;
            }
      
            // (Request 3: Rebranding)
            return `[웨이팅 인터넷 통합접수센터] 상품 & 사은품 요약 안내
    안녕하세요, 웨이팅 인터넷 통합접수센터 입니다.
    고객님께서 오늘 상담 받으신 상품 안내드립니다.
    ${productDescriptionInfo}
      
    ${finalCostBlock}
      
    * 혜택은 실시간으로 바뀔 수 있다는 점 안내드립니다.
    * 3년 약정 기준 (안내된 월 요금은 VAT 별도 기준이며, 실제 청구 시 10%의 부가세가 추가됩니다.)
    웨이팅 인터넷 통합접수센터 드림. ❤️`;
        }
          
        function generateComparisonScript() {
            try {
                const isBundleType = document.querySelector('input[name="internetType"]:checked').value === 'bundle';
                const planName100M = isBundleType ? "KT인터넷번들100mb" : "KT인터넷(단독) 100mb";
                const planName500M = isBundleType ? "KT인터넷번들500mb" : "KT인터넷(단독) 500mb";
      
                const results100M = getCalculationResults({ forcedInternetPlanName: planName100M });
                const results500M = getCalculationResults({ forcedInternetPlanName: planName500M });
      
                if (!results100M || !results500M) {
                    throw new Error("결과를 계산할 수 없습니다.");
                }
      
                const scriptBlock100M = generateSimpleProductScript(results100M);
                const scriptBlock500M = generateSimpleProductScript(results500M);
      
                // Use Pre-VAT costs for comparison in this script
                const cost100M = results100M.finalMonthlyCost_PreVat - results100M.cardDiscountAmount;
                const cost500M = results500M.finalMonthlyCost_PreVat - results500M.cardDiscountAmount;

                const monthlyCostDifference = cost500M - cost100M;
                const giftDifference = results500M.confirmedGiftAmount - results100M.confirmedGiftAmount;
      
                // (Request 3: Rebranding)
                const comparisonScript = `[웨이팅 인터넷 통합접수센터] 100Mbps vs 500Mbps 상품 비교 안내
      
    고객님께서 선택하신 옵션 기준으로, 인터넷 속도만 변경했을 때의 요금과 혜택을 비교해 드립니다. (⚠️모든 요금 VAT 별도)
      
    ----- 100M -----
    ${scriptBlock100M}
    --------------------
      
    ----- 500M -----
    ${scriptBlock500M}
    --------------------
      
    고객님, 혹시 알고 계셨나요?
    지금 선택하신 100Mbps 요금에 월 ${monthlyCostDifference.toLocaleString()}원(VAT 별도)만 추가하시면,
    ✅ 인터넷 속도는 5배 빨라지고,
    ✅ 첫 달에 받으시는 사은품은 ${(giftDifference / 10000).toLocaleString()}만원 더 커집니다!
      
    온 가족이 동시에 접속해도 끊김 없는 500Mbps 상품으로 변경 원하시면 편하게 말씀해주세요. 😊`;
      
                infoScriptEl.value = comparisonScript.trim();
            } catch (error) {
                console.error("비교 스크립트 생성 중 오류:", error);
                infoScriptEl.value = "비교 스크립트 생성 중 오류가 발생했습니다. 선택 항목을 확인해주세요.";
            }
        }
          
        function generateDiscountTypeComparisonScript() {
            try {
                const resultsTotal = getCalculationResults({ forcedDiscountType: 'totalAmountBundle' });
                const resultsFixed = getCalculationResults({ forcedDiscountType: 'fixedRateBundle' });
      
                if (!resultsTotal || !resultsFixed) {
                    throw new Error("결과를 계산할 수 없습니다.");
                }
      
                const scriptBlockTotal = generateSimpleDiscountScript(resultsTotal);
                const scriptBlockFixed = generateSimpleDiscountScript(resultsFixed);
      
                // Use Pre-VAT costs for comparison in this script
                const costTotal = resultsTotal.finalMonthlyCost_PreVat - resultsTotal.cardDiscountAmount;
                const costFixed = resultsFixed.finalMonthlyCost_PreVat - resultsFixed.cardDiscountAmount;

                const monthlyDifference = Math.abs(costTotal - costFixed);
                const whoIsCheaper = costFixed < costTotal ? "정액 결합" : "총액 결합";
                const cheaperByText = monthlyDifference > 0 ? `월 ${monthlyDifference.toLocaleString()}원 더 저렴합니다!` : "월 요금이 동일합니다.";
      
                const isStandalone = resultsFixed.tvPlanName === 'none' && resultsFixed.phonePlanName === 'none';
                const is500MPlus = resultsFixed.currentInternet.speed >= 500;
                let specialNote = "";
                if (isStandalone && is500MPlus) {
                    // 11,000원 (VAT 포함) -> 10,000원 (VAT 별도)
                    specialNote = "\n\n💡 특히 고객님처럼 500M 이상 인터넷만 단독으로 사용하실 경우, '정액 결합'은 인터넷 요금에서만 총 10,000원의 강력한 할인을 제공하여 더욱 유리합니다.";
                } else {
                     specialNote = "\n\n💡 '총액 결합'은 결합하는 휴대폰 요금 총액이 높을수록 할인 혜택이 커지는 방식이고, '정액 결합'은 휴대폰 요금제와 관계없이 일정 금액을 할인해주는 간단한 방식입니다.";
                }
      
      
                // (Request 3: Rebranding)
                const comparisonScript = `[웨이팅 인터넷 통합접수센터] 총액결합 vs 정액결합, 고객님께 딱 맞는 할인은?
      
    고객님께서 선택하신 상품 기준으로, 두 가지 핵심 결합 방식의 차이를 알기 쉽게 비교해 드립니다. (⚠️모든 요금 VAT 별도)
      
    ----- 총액 결합할인 -----
    ${scriptBlockTotal}
    -----------------------------
      
    ----- 정액 결합할인 -----
    ${scriptBlockFixed}
    -----------------------------
      
    [최종 비교]
    고객님의 현재 조건에서는 '${whoIsCheaper}' 방식이 ${cheaperByText}${specialNote}
      
    어떤 결합 방식으로 진행해 드릴까요? 😊`;
      
                infoScriptEl.value = comparisonScript.trim();
            } catch (error) {
                console.error("할인 유형 비교 스크립트 생성 중 오류:", error);
                infoScriptEl.value = "할인 유형 비교 스크립트 생성 중 오류가 발생했습니다. 선택 항목을 확인해주세요.";
            }
        }
          
        // Updated for VAT handling in comparison scripts
        function generateSimpleProductScript(results) {
            const { 
                internetPlanName, tvPlanName, additionalTvPlanKey, phonePlanName, selectedWifiData,
                confirmedGiftAmount,
                cardDiscountAmount,
                // Use Pre-VAT costs
                finalMonthlyCost_PreVat
            } = results;
      
            const internetOption = Array.from(internetPlanEl.options).find(opt => opt.value === internetPlanName);
            const internetPlanText = internetOption ? internetOption.text.split(' (')[0] : '인터넷 미선택';
             
            const tvOption = Array.from(tvPlanEl.options).find(opt => opt.value === tvPlanName);
            let firstTvText = "미선택";
            if (tvOption && tvOption.value !== 'none' && tvPlans_KT[tvOption.value]) {
                firstTvText = tvOption.text.split(' (')[0];
            }
            const additionalTvText = additionalTvPlanKey !== 'none' ? ` + (추가) ${additionalTvPlans_KT[additionalTvPlanKey].name}` : "";
             
            const phoneOption = Array.from(phonePlanEl.options).find(opt => opt.value === phonePlanName);
            let phoneText = "미선택";
            if (phoneOption && phoneOption.value !== 'none') {
                phoneText = phoneOption.text.split(' (')[0];
            }
      
            let desc = `[유선 상품]
    ▶️ ${internetPlanText}
    ▶️ ${firstTvText !== '미선택' ? firstTvText : 'TV 미선택'}${additionalTvText}
    ▶️ ${phoneText !== '미선택' ? phoneText : '집전화 미선택'}`;
      
            if (selectedWifiData && selectedWifiData.name !== "KT공유기 X") {
                desc += `\n▶️ ${selectedWifiData.name}`;
            }
      
            // Calculate Pre-VAT cost after card discount
            const finalCostToShow = finalMonthlyCost_PreVat - cardDiscountAmount;
      
            desc += `\n\n[최종 요금 및 혜택]
    ▶️ 월 ${finalCostToShow.toLocaleString()}원 (⚠️VAT 별도)
    ▶️ 사은품 ${confirmedGiftAmount.toLocaleString()}원 (확정)`;
             
            return desc;
        }
          
        // Updated for VAT handling in comparison scripts
        function generateSimpleDiscountScript(results) {
            const {
                internetDiscount,
                currentTvDiscount,
                totalMobileDiscount,
                cardDiscountAmount,
                discountType,
                // Use Pre-VAT costs
                finalMonthlyCost_PreVat
            } = results;
      
            const discountTypeMap = {
                totalAmountBundle: "총액 결합할인",
                fixedRateBundle: "정액 결합할인"
            };
            
            // Calculate Pre-VAT cost after card discount
            const finalCostToShow = finalMonthlyCost_PreVat - cardDiscountAmount;
            const cardText = cardDiscountAmount > 0 ? " (카드 적용가)" : "";
             
            // (Request 4: Ensure internet discount is displayed VAT included in this script)
            // Wait, this script is used by the Comparison script generator, which explicitly states VAT 별도.
            // So, internet discount should also be VAT 별도 here.
            const internetDiscountTotal = internetDiscount + currentTvDiscount;
      
            return `[결합 방식] ${discountTypeMap[discountType]}
    ▶️ 최종 월 요금: ${finalCostToShow.toLocaleString()}원${cardText} (⚠️VAT 별도)
    ▶️ 인터넷 할인: ${internetDiscountTotal.toLocaleString()}원 (VAT 별도)
    ▶️ 휴대폰 할인: ${totalMobileDiscount.toLocaleString()}원 (VAT 포함)`; // Mobile discounts are inherently VAT included amounts
        }
          
        function compareAndRecommend(selectedResults) {
            const { discountType, finalMonthlyCost, cardDiscountAmount, finalCostWithCard } = selectedResults;
      
            if (discountType !== 'totalAmountBundle' && discountType !== 'fixedRateBundle') {
                return { show: false };
            }
      
            const alternativeDiscountType = discountType === 'totalAmountBundle' ? 'fixedRateBundle' : 'totalAmountBundle';
            const alternativeResults = getCalculationResults({ forcedDiscountType: alternativeDiscountType });
      
            // Compare using VAT-INCLUSIVE costs for accurate recommendation
            const selectedCost = cardDiscountAmount > 0 ? finalCostWithCard : finalMonthlyCost;
            const alternativeCost = alternativeResults.cardDiscountAmount > 0 ? alternativeResults.finalCostWithCard : alternativeResults.finalMonthlyCost;
      
            const difference = Math.abs(selectedCost - alternativeCost);
      
            const selectedPlanName = discountType === 'totalAmountBundle' ? '총액 결합할인' : '정액 결합할인';
            const alternativePlanName = alternativeDiscountType === 'totalAmountBundle' ? '총액 결합할인' : '정액 결합할인';
      
            if (difference < 100) {
                 return {
                    show: true,
                    title: "✅ 고객님께 가장 유리한 할인 유형입니다!",
                    body: `현재 선택하신 '${selectedPlanName}'이 '총액/정액 결합' 중에서 가장 좋은 조건입니다.`,
                    actionHTML: ''
                };
            }
      
            if (selectedCost < alternativeCost) {
                return {
                    show: true,
                    title: "✅ 고객님께 가장 유리한 할인 유형입니다!",
                    body: `현재 선택하신 '${selectedPlanName}'이 '${alternativePlanName}'보다 월 ${difference.toLocaleString()}원 더 저렴하여 가장 좋은 조건입니다.`,
                    actionHTML: ''
                };
            } else {
                const actionButton = `<button onclick="switchAndRecalculate('${alternativeDiscountType}')" class="btn-primary text-xs py-1 px-3">⚡ ${alternativePlanName}으로 변경 후 다시 계산</button>`;
                return {
                    show: true,
                    title: "✨ 더 유리한 할인 조합을 찾았어요!",
                    body: `잠깐! 할인 유형을 <strong class="text-red-600">'${alternativePlanName}'</strong>으로 변경하시면 월 <strong class="text-red-600">${difference.toLocaleString()}원</strong>을 추가로 아낄 수 있습니다!`,
                    actionHTML: actionButton
                };
            }
        }
          
        window.switchAndRecalculate = function(newDiscountType) {
            document.querySelector(`input[name="discountType"][value="${newDiscountType}"]`).checked = true;
            document.querySelector(`input[name="discountType"][value="${newDiscountType}"]`).dispatchEvent(new Event('change'));
            calculateAndDisplayResults();
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }
          
        window.copyToClipboard = function(elementId, feedbackElementId) {
            const textarea = document.getElementById(elementId);
            if (!textarea) return;
             
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    const feedbackEl = document.getElementById(feedbackElementId);
                    if (feedbackEl) feedbackEl.textContent = '복사되었습니다!';
                    setTimeout(() => { if (feedbackEl) feedbackEl.textContent = ''; }, 2000);
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    const feedbackEl = document.getElementById(feedbackElementId);
                    if (feedbackEl) feedbackEl.textContent = '복사 실패';
                    setTimeout(() => { if (feedbackEl) feedbackEl.textContent = ''; }, 2000);
                });
            } else {
                textarea.select();
                textarea.setSelectionRange(0, 99999);
                try {
                    document.execCommand('copy');
                    const feedbackEl = document.getElementById(feedbackElementId);
                    if (feedbackEl) feedbackEl.textContent = '복사되었습니다!';
                    setTimeout(() => { if (feedbackEl) feedbackEl.textContent = ''; }, 2000);
                } catch (err) {
                    const feedbackEl = document.getElementById(feedbackElementId);
                    if (feedbackEl) feedbackEl.textContent = '복사 실패';
                    setTimeout(() => { if (feedbackEl) feedbackEl.textContent = ''; }, 2000);
                }
                window.getSelection().removeAllRanges();
            }
        }
          
        function setInitialDefaults() {
            // 1. Set new defaults
            document.querySelector('input[name="internetType"][value="bundle"]').checked = true;
            populateInternetPlans(); // Repopulate plans based on 'bundle' type
            internetPlanEl.value = "KT인터넷번들500mb+OTT";
            tvPlanEl.value = "KTTV에센스";
            affiliateCardEl.value = 'samsung';

            // 2. Reset other fields
            additionalTvPlanEl.value = "none";
            phonePlanEl.value = "none";
            wifiRouterRentalEl.value = "1000";
            wifiRouterRentalEl.disabled = false;
            document.getElementById('installationFeeSelfPay').checked = false;
            const addonCheckboxes = document.querySelectorAll('#addonServicesContainer input[type="checkbox"]');
            addonCheckboxes.forEach(cb => cb.checked = false);
            document.querySelector('input[name="discountType"][value="totalAmountBundle"]').checked = true;
            document.querySelector('input[name="installationTime"][value="weekday"]').checked = true;
            if (dongpanSalesCheckKtEl) {
                dongpanSalesCheckKtEl.checked = false;
                if(dongpanPolicyDetailsContainerKtEl) dongpanPolicyDetailsContainerKtEl.classList.add('hidden');
            }

            // 3. Trigger change events to update UI and dependent logic
            affiliateCardEl.dispatchEvent(new Event('change')); // This populates and shows card tiers

            // Explicitly select the 300,000 KRW tier for Samsung card after the change event has populated the tiers
            setTimeout(() => {
                const samsung300kTier = document.querySelector('input[name="cardTier"][value="18000"]');
                if (samsung300kTier) {
                    samsung300kTier.checked = true;
                }
            }, 0);


            // 4. Collapse all details sections
            allDetailSections.forEach(section => {
                if (section.containerEl && section.toggleEl) {
                    section.toggleEl.checked = false;
                    section.containerEl.classList.add('hidden');
                }
            });

            // 5. Trigger other major change events
            document.querySelector('input[name="internetType"]:checked').dispatchEvent(new Event('change'));
            document.querySelector('input[name="discountType"]:checked').dispatchEvent(new Event('change')); //This also calls updateMobileLinesInputs

            // Final UI state updates
            updateDiscountTypeAvailability();
        }
          
        function resetCalculator() {
            setInitialDefaults();
            resultSection.classList.add('hidden');
            installationFeeSectionEl.classList.add('hidden');
            messageScriptSectionEl.classList.add('hidden');
            // (Request 2: Removed Gemini card hiding logic)
            expandedDetailsContainer.classList.add('hidden');
            toggleDetailsButton.innerHTML = '상세 요금 내역 펼쳐보기 ▼';
            if(selectedWifiDetailsEl) selectedWifiDetailsEl.innerHTML = '';
            window.scrollTo(0, 0);
        }
          
        function updateDiscountTypeAvailability() {
            const internetOption = internetPlanEl.options[internetPlanEl.selectedIndex];
            const internetSpeed = internetOption && internetOption.value !== 'none' ? parseInt(internetOption.dataset.speed) : 0;
      
            let totalMobileCost = 0;
            document.querySelectorAll('.mobile-line-item').forEach((item, i) => {
                const select = item.querySelector(`#mobilePlan${i}`);
                totalMobileCost += parseInt(select.value) || 0;
            });
      
            const separateFamilyRadio = document.querySelector('input[name="discountType"][value="separateFamilyBundle"]');
            const separateFamilyLabel = separateFamilyRadio.parentElement;
      
            const isEligible = internetSpeed >= 500 && totalMobileCost >= 37000;
      
            if (isEligible) {
                separateFamilyRadio.disabled = false;
                separateFamilyLabel.classList.remove('text-slate-400', 'cursor-not-allowed');
            } else {
                separateFamilyRadio.disabled = true;
                separateFamilyLabel.classList.add('text-slate-400', 'cursor-not-allowed');
                if (separateFamilyRadio.checked) {
                    document.querySelector('input[name="discountType"][value="totalAmountBundle"]').checked = true;
                }
            }
        }
          
        // (Request 2: Removed callGeminiAPI function)
      
        function generatePersuasionScripts(currentInternet) {
            const internetSpeed = currentInternet.speed;
            // (Request 3: Rebranding)
            let tcoScript = `[웨이팅 인터넷 통합접수센터] 3년 약정이 부담스러우신가요?\n1년만 써도 더 이득인 이유, 정확히 비교해 드릴게요!\n\n안녕하세요, 고객님.\n약정 기간 때문에 고민하시는 마음 충분히 이해합니다.\n\n그래서 KT 공식 약관 기준으로, 1년 약정과 3년 약정의 실제 총비용(TCO)을 꼼꼼하게 비교해 드렸습니다.\n\n놀랍게도, 3년 약정은 1년(13개월)만 사용하고 해지해도 1년 약정보다 훨씬 저렴합니다.\n심지어 1년 6개월(18개월) 사용 시 혜택 차이는 더 커집니다.`;
            // (Request 3: Rebranding)
            let penaltyScript = `[웨이팅 인터넷 통합접수센터] KT 위약금, 정확한 계산 방식이 궁금하신가요?\n고객님의 알 권리를 위해, KT의 공식 할인반환금(위약금) 산정 방식을 투명하게 안내해 드립니다.\n\n**1. KT의 새로운 위약금 공식**\nKT는 아래 공식에 따라 위약금을 산정합니다.\n▶ 위약금 = (총 할인받은 금액) x (1 - 감면율)\n- 총 할인액: (정상가-약정가) x 이용 개월 수\n- 감면율: 약정 기간을 채울수록 위약금을 깎아주는 비율\n\n**2. 꼭 아셔야 할 핵심 포인트 1: '180일'의 비밀**\nKT 약관상, 가입 후 첫 6개월(180일) 동안은 위약금 감면이 적용되지 않습니다. 이 기간에는 할인받은 금액이 그대로 위약금으로 누적되어, 초반 해지 시 부담이 가장 큽니다.\n\n**3. 꼭 아셔야 할 핵심 포인트 2: '18개월'의 최고점과 그 이후**\n위약금은 약정 기간의 절반인 18개월 차에 최고점에 도달하고, 그 이후부터는 감면율이 크게 높아져 위약금이 계속해서 감소하는 구조입니다.`;
      
            if (internetSpeed === 100) {
                tcoScript += `\n\n[인터넷 단독 (100Mbps) 총비용 비교]\n--------------------------------\n🆚 1년 약정\n- 월 요금: 34,650원\n- 13개월 총비용: 약 450,450원\n- 18개월 총비용: 약 623,700원\n\n✅ 3년 약정 (중도 해지 시)\n- 월 요금: 22,000원 (사은품 9만원 포함)\n- 13개월 총비용: 약 333,600원 (👉 11만원 이상 이득!)\n- 18개월 총비용: 약 447,000원 (👉 17만원 이상 이득!)\n--------------------------------`;
                penaltyScript += `\n\n(예시: 100M 인터넷, 매달 22,000원 할인 시)\n- 13개월 차 위약금: 약 218,790원\n- 18개월 차 위약금: 약 237,204원 (최고점)\n- 24개월 차 위약금: 약 210,672원 (다시 감소 시작)`;
            } else if (internetSpeed === 500) {
                tcoScript += `\n\n[인터넷 단독 (500Mbps) 총비용 비교]\n--------------------------------\n🆚 1년 약정\n- 월 요금: 41,800원\n- 13개월 총비용: 약 543,400원\n- 18개월 총비용: 약 752,400원\n\n✅ 3년 약정 (중도 해지 시)\n- 월 요금: 33,000원 (사은품 14만원 포함)\n- 13개월 총비용: 약 439,400원 (👉 10만원 이상 이득!)\n- 18개월 총비용: 약 577,000원 (👉 17만원 이상 이득!)\n--------------------------------`;
                penaltyScript += `\n\n(위약금 예시는 100M 기준이며, 500M도 유사한 구조로 계산됩니다.)`;
            }
      
            tcoScript += `\n\n✨ 가장 중요한 포인트!\n3년 약정은 시간이 지날수록 위약금이 크게 줄어듭니다. 특히 약정 기간의 절반인 1년 6개월(18개월)이 지나면 부담이 훨씬 덜해지기 때문에, 예상보다 오래 사용하실수록 3년 약정이 압도적으로 유리합니다.\n\n※ TCO(총 소유 비용)란? 월 요금, 사은품 혜택, 중도 해지 시 위약금까지 모두 계산했을 때, 고객님께서 실제로 부담하시는 총 금액입니다.\n※ 출처: kt.com 법적고지 > 초고속인터넷 이용약관\n\n결론적으로, 혹시 모를 상황으로 중도에 해지하시더라도 3년 약정으로 시작하시는 것이 모든 면에서 가장 경제적인 선택입니다. 😊`;
            penaltyScript += `\n\n**4. 결론: 가장 합리적인 선택과 '안전장치'**\n이러한 구조 때문에, 1년 이상 사용하실 계획이라면 앞서 보내드린 'TCO 비교' 자료에서 보셨듯 3년 약정이 압도적으로 유리합니다.\n\n또한, 이사 시 설치 불가 등 약관에 명시된 정당한 사유가 발생하면 위약금 없이 해지가 가능한 '위약금 면제'라는 안전장치도 마련되어 있으니 안심하셔도 좋습니다.\n\n※ 출처: kt.com 법적고지 > 초고속인터넷 이용약관`;
             
            // (Request 3: Rebranding)
            const waiverScript = `[웨이팅 인터넷 통합접수센터] 고객님의 권리, '위약금 면제 조건' 상세 안내\n\n안녕하세요, 고객님.\n3년 약정 기간 중 예기치 못한 상황이 발생할까 걱정되실 수 있습니다.\n고객님의 알 권리를 위해, 약관에 명시된 '위약금 면제(합법적 해지)' 조건들을 투명하게 안내해 드립니다.\n\n아래 조건에 해당될 경우, 위약금 없이 계약을 해지하실 수 있습니다.\n\n**1. 서비스 품질이 기준에 미달하는 경우**\n- 인터넷 속도가 '최저보장속도(SLA)' 기준에 지속적으로 미달 (월 5회 이상 측정 기록 필요)\n- 서비스 장애로 A/S를 월 3회 이상 받았으나 개선되지 않을 경우\n- 월 누적 장애 시간이 통신사 기준(KT/LGU+ 48시간)을 초과한 경우\n\n**2. 이사 등으로 서비스 이용이 불가능한 경우**\n- 이사한 장소가 통신사의 서비스 제공 불가 지역인 경우 (가장 일반적인 면제 사유)\n- 이사한 건물이 특정 통신사와 독점 계약 상태라 타사 인터넷 설치가 불가능한 경우\n\n**3. 가입자 개인의 피치 못할 사정이 생긴 경우**\n- 계약자 본인이 군에 입대하는 경우 (입영통지서 등 증빙 서류 필요)\n- 계약자가 사망한 경우\n\n이처럼 고객님을 보호하기 위한 여러 '안전장치'가 마련되어 있습니다.\n이러한 조건들을 확인하시고, 가장 경제적인 3년 약정을 안심하고 선택하시길 바랍니다.\n\n※ 출처: 통신사 이용약관 및 방송통신위원회 관련 규정`;
      
            tcoComparisonScriptEl.value = tcoScript;
            penaltyAnalysisScriptEl.value = penaltyScript;
            penaltyWaiverScriptEl.value = waiverScript;
      
            // (Request 3: Rebranding)
            if (usimCompleteScriptEl) {
                usimCompleteScriptEl.value = ` 유심 접수 완료 안내
    안녕하세요, 고객님.
    인터넷 통합접수센터입니다.
    ✅ 유심동판 접수가 완료되었어요, 아래 내용은 계약서와 동일한 효력이 있으니 꼼꼼히 읽어주세요.
    ⚠️ 12개월/24개월 약정이며, 아래와 같은 상황에 해당하면 받으셨던 사은품은 환수 됩니다.
    ① 183일 이내 해지 및 요금제 하향
    ② 개통 후 무통화 대상
    ③ 183일 이내 명의변경 통신사 변경 시
    ④ 183일 이내 결합 해지
    ⑤ 인터넷 개통 후 익월 말일까지 꼭 유심 개통이 필요해요!
    ⚠️ 유심 개통 완료 되면 사용하셨던 유심과 교체하여 기기 전원을 3~4회 껏다 키시면 됩니다!
    ✅사은품은 설치 후 7일 이내 자동으로 지급되나 평일기준 5시 이전 개통 받았다고 문자 주시면 당일입금 도움드리겠습니다.
    🔊 해당 연락처로 연락이 어려울 경우 걱정하지 마세요! 아래 대표번호로 문의주시면 확인하여 연락드리겠습니다. 시간 양해 부탁드려요.
    [웨이팅 인터넷 통합접수센터를 소개해주세요]
    지인이 웨이팅 인터넷 통합접수센터에서 인터넷 설치하면 소개해주신 분에게 3만원 드려요.
    ▶ 지인에게 추천하고 3O,OOO원 받기 (↓)
    https://get.miso.kr/pZbfsUPthzb
    웨이팅 인터넷 통합접수센터 드림.
    ☎ 대표번호 1577-8808 오전 9시 ~ 오후 10시 (연중무휴)`;
            }
             
            if (sensitiveInfoLinkScriptEl) {
                sensitiveInfoLinkScriptEl.value = `[KT] 아래 링크에 고객님의 민감정보를 입력하시면 KT로 고객님의 민감정보가 직접 전송후 접수 됩니다.
    입력후 접수 완료 라고 문자 주시면 담당 상담원이 접수 확인후 필수 안내사항 안내 드리겠습니다.
    https://kt-sensitiveinfo.com/`;
            }
        }
      
      
        window.onload = setInitialDefaults;
    </script>
</body>
</html>
